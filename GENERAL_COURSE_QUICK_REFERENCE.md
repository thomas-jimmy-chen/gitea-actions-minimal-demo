# ä¸€èˆ¬èª²ç¨‹ API è‡ªå‹•åŒ–å¿«é€Ÿåƒè€ƒæ‰‹å†Š

> **ç”¨é€”**: 5 åˆ†é˜å¿«é€Ÿäº†è§£ä¸€èˆ¬èª²ç¨‹ï¼ˆéè€ƒè©¦ï¼‰çš„ç´” API è‡ªå‹•åŒ–æ–¹æ¡ˆ
> **å®Œæ•´å ±å‘Š**: [GENERAL_COURSE_API_AUTOMATION.md](./GENERAL_COURSE_API_AUTOMATION.md)

---

## ğŸ¯ æ ¸å¿ƒçµè«–

### âœ… ä¸€èˆ¬èª²ç¨‹å¯ä»¥ç´” JSON é€å‡ºï¼

**èˆ‡è€ƒè©¦çš„æœ€å¤§å·®ç•°**ï¼š
- âŒ è€ƒè©¦ï¼šéœ€è¦ `exam_paper_instance_id`ï¼ˆå‹•æ…‹ç”Ÿæˆï¼Œå¿…é ˆé€²å…¥é é¢ï¼‰
- âœ… ä¸€èˆ¬èª²ç¨‹ï¼š**ç„¡éœ€ä»»ä½•å‹•æ…‹ ID**ï¼Œæ‰€æœ‰æ¬„ä½å¯äº‹å…ˆæº–å‚™

---

## ğŸ”‘ æ ¸å¿ƒ API

```
POST /statistics/api/user-visits
```

**å›æ‡‰**: `204 No Content`ï¼ˆæˆåŠŸï¼‰

---

## ğŸ“‹ Request Body çµæ§‹

```json
{
  "user_id": "19688",
  "org_id": "1",
  "visit_duration": 1483,          // â­ æ™‚é•·ï¼ˆç§’ï¼‰
  "is_teacher": false,
  "browser": "chrome",
  "user_agent": "Mozilla/5.0...",
  "visit_start_from": "2025/12/03T10:30:00",
  "org_name": "éƒµæ”¿ï½…å¤§å­¸",
  "user_no": "522673",
  "user_name": "é™³å‰é³´",
  "dep_id": "156",
  "dep_name": "æ–°èˆˆæŠ•éè‚¡",
  "dep_code": "0040001013",

  // å¯é¸æ¬„ä½ï¼ˆæœ‰èª²ç¨‹å°±å¡«ï¼‰
  "course_id": "465",
  "course_code": "901011114",
  "course_name": "èª²ç¨‹åç¨±"
}
```

---

## ğŸ†š è€ƒè©¦ vs ä¸€èˆ¬èª²ç¨‹

| ç‰¹æ€§ | è€ƒè©¦ | ä¸€èˆ¬èª²ç¨‹ |
|------|------|---------|
| **å‹•æ…‹ ID** | âŒ éœ€è¦ `exam_paper_instance_id` | âœ… ç„¡éœ€ä»»ä½•å‹•æ…‹ ID |
| **å¿…é ˆé€²å…¥é é¢** | âŒ æ˜¯ | âœ… **å¦** |
| **å¯å®Œå…¨è‡ªå‹•åŒ–** | âŒ åŠè‡ªå‹• | âœ… **æ˜¯ï¼ˆç´” APIï¼‰** |
| **åŸ·è¡Œé€Ÿåº¦** | 3-5 åˆ†é˜/èª²ç¨‹ | **< 5 ç§’/èª²ç¨‹** |
| **å¯¦ä½œé›£åº¦** | ä¸­ç­‰ | ç°¡å–® |

---

## ğŸ“Š æ¬„ä½åˆ†é¡

| é¡åˆ¥ | æ¬„ä½æ•¸ | è³‡æ–™ä¾†æº | ç²å–æ™‚æ©Ÿ |
|------|--------|---------|---------|
| **ç”¨æˆ¶è³‡æ–™** | 6 å€‹ | é¦–æ¬¡ç™»å…¥å¾Œç²å– | âœ… åƒ…éœ€ä¸€æ¬¡ |
| **çµ„ç¹”è³‡æ–™** | 2 å€‹ | å›ºå®šå€¼ | âœ… å¯«æ­»é…ç½® |
| **ç€è¦½å™¨è³‡æ–™** | 2 å€‹ | EEBot å…§å»º | âœ… å›ºå®šå€¼ |
| **æ™‚é•·è³‡æ–™** | 1 å€‹ | ç¨‹å¼è¨ˆç®— | âœ… è‡ªå‹•ç”Ÿæˆ |
| **èª²ç¨‹è³‡æ–™** | 3 å€‹ | GET /api/my-courses | âœ… æƒæä¸€æ¬¡ |

**ç¸½è¨ˆ**: 13 å€‹å¿…éœ€ + 6 å€‹å¯é¸ = 19 å€‹æ¬„ä½

---

## ğŸš€ å¯¦ä½œæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: MitmProxy æ””æˆªä¿®æ”¹ï¼ˆæœ€ç°¡å–®ï¼‰â­

**æµç¨‹**:
1. EEBot æ­£å¸¸é‹è¡Œ
2. MitmProxy æ””æˆª `POST /statistics/api/user-visits`
3. ä¿®æ”¹ `visit_duration` æ¬„ä½ï¼ˆä¾‹å¦‚ï¼šä¹˜ä»¥ 10 å€ï¼‰
4. è½‰ç™¼ä¿®æ”¹å¾Œçš„è«‹æ±‚

**å„ªé»**: âœ… æœ€ç°¡å–®ã€âœ… ç«‹å³å¯ç”¨ã€âœ… ç„¡éœ€ä¿®æ”¹ EEBot

**å·¥ä½œé‡**: 1-2 å°æ™‚

---

### æ–¹æ¡ˆ 2: ç´” API æ‰¹æ¬¡æäº¤ï¼ˆæ¨è–¦ï¼‰â­â­â­

**æµç¨‹**:
```
ç¬¬ä¸€æ¬¡æº–å‚™ï¼ˆåƒ…ä¸€æ¬¡ï¼‰
â”œâ”€ 1. EEBot ç™»å…¥ â†’ ç²å– session
â”œâ”€ 2. GET /api/users/me â†’ ç²å–ç”¨æˆ¶è³‡æ–™
â”œâ”€ 3. GET /api/my-courses â†’ ç²å–èª²ç¨‹æ¸…å–®
â””â”€ 4. å„²å­˜åˆ° user_profile.json

æ—¥å¸¸ä½¿ç”¨ï¼ˆç´” APIï¼‰
â”œâ”€ 1. è®€å– user_profile.json
â”œâ”€ 2. çµ„åˆ JSON payload
â”œâ”€ 3. POST /statistics/api/user-visits
â”œâ”€ 4. ç­‰å¾… 3-5 ç§’
â””â”€ 5. é‡è¤‡æ‰€æœ‰èª²ç¨‹
```

**å„ªé»**:
- âœ… **å®Œå…¨ä¸éœ€é€²å…¥èª²ç¨‹é é¢**
- âœ… é€Ÿåº¦æ¥µå¿«ï¼ˆ< 5 ç§’/èª²ç¨‹ï¼‰
- âœ… å¯æ‰¹æ¬¡è™•ç†

**å·¥ä½œé‡**: 8-12 å°æ™‚

---

## âš ï¸ å®‰å…¨æ¼æ´

| é¢¨éšªç­‰ç´š | æ¼æ´ | å½±éŸ¿ |
|---------|------|------|
| **CRITICAL** | ç„¡ visit_duration é©—è­‰ | å¯ä»»æ„å¢åŠ æ™‚é•· |
| **CRITICAL** | ç„¡è«‹æ±‚ç°½ç«  (HMAC) | è«‹æ±‚å¯ç«„æ”¹ |
| **HIGH** | ç„¡é‡è¤‡è«‹æ±‚åµæ¸¬ | å¯é€å¤šæ¬¡ |
| **HIGH** | ç„¡æ™‚é–“æˆ³é©—è­‰ | å¯å½é€ æ™‚é–“ |

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

1. **æ™‚é•·åˆç†åŒ–**: æ¯æ—¥ < 8 å°æ™‚
2. **åŠ å…¥å»¶é²**: æ¯å€‹è«‹æ±‚é–“éš” 3-5 ç§’
3. **éš¨æ©ŸåŒ–æ™‚é•·**: é¿å…å›ºå®šå€¼
4. **ä¿æŒ session**: ç¢ºä¿ cookie æœ‰æ•ˆ

---

## ğŸ“¦ ç›¸é—œæª”æ¡ˆ

- `USER_VISITS_FIELD_MAPPING.json` - å®Œæ•´æ¬„ä½å°æ‡‰è¡¨
- `TEST2_QUICK_REFERENCE.md` - test2 åˆ†æå ±å‘Š
- `GENERAL_COURSE_API_AUTOMATION.md` - è©³ç´°å¯¦ä½œæ–¹æ¡ˆ

---

## ğŸ”— API åƒè€ƒ

```bash
# æäº¤æ™‚é•·
POST https://elearn.post.gov.tw/statistics/api/user-visits
Content-Type: application/json
Cookie: session=V2-1-xxx...

# æŸ¥è©¢æ™‚é•·
GET https://elearn.post.gov.tw/statistics/api/courses/{course_id}/users/{user_id}/user-visits/metrics
```

---

**ç‰ˆæœ¬**: 1.0 | **æ—¥æœŸ**: 2025-12-03 | **å°ˆæ¡ˆ**: EEBot (Gleipnir)
