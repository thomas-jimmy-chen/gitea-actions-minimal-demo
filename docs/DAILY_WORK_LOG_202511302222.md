# EEBot 工作日誌 - 2025-11-30 22:22

**專案代號**: Gleipnir (格萊普尼爾)
**工作階段**: 平台遷移可行性評估
**記錄者**: wizard03 (with Claude Code CLI - Sonnet 4.5)

---

## 📋 工作摘要

本次工作主要針對用戶提出的關鍵問題進行深入分析：**TronClass 與 TMS+ 是兩種不同的學習平台，如果要轉往另一個平台，掃描模組是否需要改良？**

**平台資訊更新** (2025-12-01):
- **原先誤認**: elearning 平台
- **實際平台**: TMS+ (台灣數位學習科技 FormosaSoft 開發)
- **測試網站**: https://tms.utaipei.edu.tw/ (臺北市立大學)

---

## 🔍 分析過程

### 1. 文檔閱讀與背景理解

**已讀取文檔**:
- ✅ `docs/AI_ASSISTANT_GUIDE.md` (索引)
- ✅ `docs/CLAUDE_CODE_HANDOVER.md` (索引)
- ✅ `docs/CLAUDE_CODE_HANDOVER-1.md` (基礎架構)
- ✅ `docs/CLAUDE_CODE_HANDOVER-2.md` (進階功能)
- ✅ `CHANGELOG.md` (最新變更)

**背景理解**:
- 專案名稱: EEBot (Elearn Automation Bot)
- 專案代號: Gleipnir
- 當前版本: v2.0.7
- 目標平台: TronClass (台灣郵政 e 大學)
- 架構模式: POM (Page Object Model) + API Interceptor

### 2. 掃描模組程式碼分析

**已檢查檔案**:
- ✅ `src/pages/base_page.py` - 頁面物件基類
- ✅ `src/pages/course_list_page.py` - 課程列表頁面（掃描核心）
- ✅ 其他 pages 模組清單

**分析重點**:
- 定位器策略 (XPath, CSS Selector, AngularJS 屬性)
- DOM 結構依賴程度
- 平台特定邏輯 (中文文字識別、課程狀態判斷)

---

## 🎯 核心發現

### 平台相依性評估結果

#### 🔴 嚴重相依模組

| 模組 | 平台相依度 | 關鍵問題 |
|-----|-----------|---------|
| `course_list_page.py` | 🔴🔴🔴🔴🔴 (95%) | 絕對 XPath、AngularJS 屬性、DOM 層級結構 |
| `course_detail_page.py` | 🔴🔴🔴🔴 (80%) | TronClass 特定定位器 |
| `exam_detail_page.py` | 🔴🔴🔴🔴 (80%) | 考試流程 DOM 結構 |
| `login_page.py` | 🟡🟡🟡 (60%) | 登入頁面結構 |

#### TronClass 特定元素範例

**絕對 XPath 路徑**:
```python
courses_container_xpath = "/html/body/div[2]/div[5]/div/div/div[2]/div/div[1]/div[2]"
```
**問題**: elearning 平台的 DOM 結構幾乎 100% 不同，此定位器會完全失效。

**AngularJS 屬性定位器**:
```python
"//a[@ng-bind='course.display_name']"
"//a[@ng-bind='activity.title']"
"//a[@ng-click]"
```
**問題**: 如果 elearning 不使用 AngularJS 框架，所有 `ng-*` 屬性定位器都會失效。

**DOM 層級結構依賴**:
```python
for ancestor_level in range(2, 8):
    course_card = course_link.find_element(By.XPATH, f"./ancestor::div[{ancestor_level}]")
```
**問題**: 高度依賴 TronClass 的多層 div 嵌套結構。

**中文文字硬編碼**:
```python
if '修習中' in card_text:
if '測驗' in name or '考試' in name:
```
**問題**: elearning 可能使用不同的狀態標識或英文介面。

---

## 💡 改良方案設計

### 方案 A: 策略模式 (Strategy Pattern) ⭐⭐⭐⭐⭐

**推薦理由**: 完全解耦、易於擴展、符合 SOLID 原則

**架構設計**:
```
src/pages/
├── base_page.py                    # 保持不變
├── platforms/                      # 【新增】平台抽象層
│   ├── __init__.py
│   ├── base_platform.py            # 抽象基類
│   ├── tronclass/                  # TronClass 實作
│   │   ├── __init__.py
│   │   ├── course_list_page.py     # 現有邏輯移至此處
│   │   ├── course_detail_page.py
│   │   ├── exam_detail_page.py
│   │   └── locators.py             # 定位器配置
│   └── elearning/                  # 【待開發】elearning 實作
│       ├── __init__.py
│       ├── course_list_page.py     # 新的實作
│       ├── course_detail_page.py
│       ├── exam_detail_page.py
│       └── locators.py
├── factory.py                      # 【新增】平台工廠
```

**優點**:
- ✅ 完全解耦平台邏輯
- ✅ 易於新增新平台（僅需實作新目錄）
- ✅ 保持向後相容（TronClass 邏輯完整保留）
- ✅ 符合開放封閉原則 (Open/Closed Principle)
- ✅ 測試性強（可單獨測試各平台）

**缺點**:
- ❌ 需要重構現有程式碼
- ❌ 開發時間較長（預估 8-12 小時）
- ❌ 檔案數量增加

**實作關鍵點**:
```python
# factory.py (新增)
class PlatformFactory:
    @staticmethod
    def create_course_list_page(platform: str, driver):
        if platform == 'tronclass':
            from .platforms.tronclass.course_list_page import TronClassCourseListPage
            return TronClassCourseListPage(driver)
        elif platform == 'elearning':
            from .platforms.elearning.course_list_page import ElearningCourseListPage
            return ElearningCourseListPage(driver)
        else:
            raise ValueError(f"Unsupported platform: {platform}")
```

---

### 方案 B: 配置驅動 (Config-Driven) ⭐⭐⭐⭐

**推薦理由**: 實作簡單、快速部署、靈活切換

**架構設計**:
```
config/
├── eebot.cfg                       # 現有配置
├── platforms/                      # 【新增】平台定位器配置
│   ├── tronclass.json              # TronClass 定位器
│   └── elearning.json              # elearning 定位器
```

**配置檔範例** (`config/platforms/tronclass.json`):
```json
{
  "platform_name": "TronClass",
  "course_list_page": {
    "courses_container": "/html/body/div[2]/div[5]/div/div/div[2]/div/div[1]/div[2]",
    "course_link": "//a[@ng-bind='course.display_name']",
    "activity_link": "//a[@ng-bind='activity.title']",
    "in_progress_label": "修習中",
    "exam_keywords": ["測驗", "考試"],
    "my_courses_link_text": "我的課程"
  },
  "course_detail_page": {
    "lesson_link": "//a[@ng-click='goLesson({0})']",
    "back_link": "//a[@ng-click='goBackCourse({0})']"
  },
  "exam_detail_page": {
    "continue_button": "//button[contains(text(), '繼續答題')]",
    "agreement_checkbox": "//input[@type='checkbox' and @ng-model='agreed']"
  }
}
```

**程式碼修改** (`course_list_page.py`):
```python
class CourseListPage(BasePage):
    def __init__(self, driver: webdriver.Chrome, platform: str = 'tronclass'):
        super().__init__(driver)
        self.platform = platform
        self.locators = self._load_platform_locators(platform)

    def _load_platform_locators(self, platform: str) -> dict:
        """載入平台定位器配置"""
        config_path = f'config/platforms/{platform}.json'
        with open(config_path, 'r', encoding='utf-8') as f:
            return json.load(f)

    def get_in_progress_programs(self) -> list:
        # 使用動態定位器
        container_xpath = self.locators['course_list_page']['courses_container']
        course_link_xpath = self.locators['course_list_page']['course_link']
        in_progress_label = self.locators['course_list_page']['in_progress_label']

        # 原有邏輯，但使用動態定位器
        ...
```

**優點**:
- ✅ 實作簡單（僅需修改載入邏輯）
- ✅ 無需重構核心邏輯
- ✅ 快速切換平台（修改 `eebot.cfg` 中的 `platform` 參數）
- ✅ 定位器集中管理，易於維護

**缺點**:
- ❌ 需要手動配置每個定位器（約 30-50 個）
- ❌ 平台邏輯差異大時會遇到限制（僅適用於定位器差異）
- ❌ 無法處理平台特定的業務邏輯差異

---

### 方案 C: 自動偵測平台 (Auto-Detection) ⭐⭐⭐

**推薦理由**: 使用者無感、全自動

**實作概念**:
```python
# src/utils/platform_detector.py (新增)
class PlatformDetector:
    @staticmethod
    def detect(driver: webdriver.Chrome) -> str:
        """自動偵測當前平台"""
        try:
            # 檢查 AngularJS 應用 (TronClass 特徵)
            if driver.find_elements(By.XPATH, "//div[@ng-app]"):
                return 'tronclass'

            # 檢查 elearning 容器 (假設的特徵)
            if driver.find_elements(By.CSS_SELECTOR, ".elearn-container"):
                return 'elearning'

            # 檢查 URL 特徵
            current_url = driver.current_url
            if 'elearn.post.gov.tw' in current_url:
                return 'tronclass'
            elif 'elearning.example.com' in current_url:
                return 'elearning'

            return 'unknown'
        except Exception as e:
            print(f'[ERROR] Platform detection failed: {e}')
            return 'unknown'
```

**優點**:
- ✅ 全自動，使用者無需配置
- ✅ 支援動態切換平台
- ✅ 可與方案 A 或 B 結合使用

**缺點**:
- ❌ 實作複雜
- ❌ 需要準確的平台特徵識別
- ❌ 可能誤判（特徵相似時）

---

## 📊 改良工作量評估

### 詳細任務分解

| 階段 | 任務 | 預估時間 | 優先級 | 依賴 |
|-----|------|---------|--------|-----|
| **Phase 1: 評估與設計** | | | | |
| 1.1 | 評估 elearning 平台 HTML 結構 | 1-2 小時 | P0 | 需要 elearning URL |
| 1.2 | 設計平台抽象層架構 | 1 小時 | P0 | - |
| 1.3 | 制定定位器配置規範 | 0.5 小時 | P1 | - |
| **Phase 2: 基礎設施** | | | | |
| 2.1 | 建立平台目錄結構 | 0.5 小時 | P0 | Phase 1.2 |
| 2.2 | 實作平台工廠模式 | 1 小時 | P0 | Phase 2.1 |
| 2.3 | 建立抽象基類 (base_platform.py) | 1 小時 | P0 | Phase 2.1 |
| **Phase 3: TronClass 重構** | | | | |
| 3.1 | 提取 course_list_page.py 定位器 | 2 小時 | P0 | Phase 2 |
| 3.2 | 重構 course_list_page.py | 2 小時 | P0 | Phase 3.1 |
| 3.3 | 重構 course_detail_page.py | 1.5 小時 | P0 | Phase 3.2 |
| 3.4 | 重構 exam_detail_page.py | 1.5 小時 | P0 | Phase 3.2 |
| 3.5 | 重構 login_page.py | 1 小時 | P1 | Phase 3.2 |
| **Phase 4: elearning 實作** | | | | |
| 4.1 | 建立 elearning 定位器配置 | 2 小時 | P0 | Phase 1.1, 3.1 |
| 4.2 | 實作 elearning course_list_page | 2 小時 | P0 | Phase 4.1 |
| 4.3 | 實作 elearning course_detail_page | 1.5 小時 | P0 | Phase 4.1 |
| 4.4 | 實作 elearning exam_detail_page | 1.5 小時 | P0 | Phase 4.1 |
| **Phase 5: 整合與測試** | | | | |
| 5.1 | 修改 main.py 整合平台工廠 | 1 小時 | P0 | Phase 4 |
| 5.2 | 修改 menu.py 整合平台工廠 | 1 小時 | P0 | Phase 4 |
| 5.3 | 測試 TronClass 平台（回歸測試） | 2 小時 | P0 | Phase 5.1 |
| 5.4 | 測試 elearning 平台 | 2 小時 | P0 | Phase 5.2 |
| 5.5 | 測試雙平台切換機制 | 1 小時 | P1 | Phase 5.3, 5.4 |
| **Phase 6: 進階功能（選用）** | | | | |
| 6.1 | 實作平台自動偵測功能 | 2 小時 | P2 | Phase 5 |
| 6.2 | 實作平台配置 GUI 管理器 | 3 小時 | P3 | Phase 5 |
| **總計** | | **28-32 小時** | | |

### 里程碑規劃

| 里程碑 | 完成標準 | 交付物 | 預估完成時間 |
|-------|---------|-------|------------|
| **M1: 架構設計** | 平台抽象層設計完成 | 設計文檔、目錄結構 | 2-3 小時 |
| **M2: TronClass 遷移** | TronClass 邏輯遷移至新架構 | 重構後的 pages 模組 | 6-8 小時 |
| **M3: elearning 實作** | elearning 平台基本支援 | elearning pages 實作 | 6-8 小時 |
| **M4: 整合測試** | 雙平台切換成功 | 測試報告 | 4-5 小時 |
| **M5: 文檔更新** | 技術文檔更新完成 | 更新後的交接文檔 | 2-3 小時 |

---

## 🎯 待辦事項清單

**已建立待辦事項** (使用 TodoWrite 工具):

1. ⬜ 評估 elearning 平台 HTML 結構與定位器
2. ⬜ 設計平台抽象層架構（策略模式 vs 配置驅動）
3. ⬜ 提取 TronClass 定位器到配置檔（tronclass.json）
4. ⬜ 重構 course_list_page.py 支援多平台
5. ⬜ 重構 course_detail_page.py 支援多平台
6. ⬜ 重構 exam_detail_page.py 支援多平台
7. ⬜ 實作平台工廠模式（PlatformFactory）
8. ⬜ 建立 elearning 平台定位器配置
9. ⬜ 測試雙平台切換機制
10. ⬜ 實作平台自動偵測功能（選用）

---

## 📝 關鍵決策點

### 需要用戶決策的問題

#### 1. elearning 平台資訊 (🔴 阻塞)
**問題**: 缺少 elearning 平台的實際 URL 與 HTML 結構
**影響**: 無法進行 Phase 1.1 評估
**需求**:
- elearning 平台的 URL
- 登入帳號（測試用）
- 或提供 HTML 結構截圖/程式碼

#### 2. 改良方案選擇 (🟡 重要)
**問題**: 策略模式 vs 配置驅動
**建議**:
- **短期方案**（1-2 週）: 配置驅動（方案 B）
- **長期方案**（1-2 個月）: 策略模式（方案 A）

**權衡分析**:
| 考量因素 | 配置驅動 | 策略模式 |
|---------|---------|---------|
| 開發時間 | 10-14 小時 | 18-24 小時 |
| 程式碼品質 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 擴展性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 維護成本 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 學習曲線 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

#### 3. 時程需求 (🟢 一般)
**問題**: 急需還是可以花時間重構？
**影響**: 決定採用哪個方案
**選項**:
- **急需** (1-2 週): 選擇配置驅動
- **可等待** (1-2 個月): 選擇策略模式

---

## 🔗 相關文檔更新

### 需要更新的文檔清單

1. **CLAUDE_CODE_HANDOVER-2.md**
   - 新增「平台遷移計畫」章節
   - 記錄平台相依性分析結果
   - 記錄改良方案設計

2. **CHANGELOG.md**
   - 新增版本規劃（v3.0.0 - Multi-Platform Support）

3. **AI_ASSISTANT_GUIDE-2.md**
   - 更新「最新更新」章節

4. **新增文檔**:
   - `docs/PLATFORM_MIGRATION_GUIDE.md` - 平台遷移指南
   - `docs/PLATFORM_ARCHITECTURE_DESIGN.md` - 平台架構設計文檔

---

## 💭 技術挑戰與風險

### 潛在風險清單

| 風險 | 嚴重性 | 可能性 | 緩解策略 |
|-----|-------|-------|---------|
| elearning 平台架構差異過大 | 🔴 高 | 🟡 中 | 採用策略模式，完全隔離平台邏輯 |
| 定位器提取遺漏關鍵元素 | 🟡 中 | 🟡 中 | 完整的回歸測試覆蓋 |
| 平台切換後功能異常 | 🔴 高 | 🟢 低 | 保留原有 TronClass 邏輯不變 |
| 開發時間超出預估 | 🟡 中 | 🟡 中 | 分階段交付，優先完成核心功能 |
| elearning 使用動態載入 (AJAX) | 🟡 中 | 🟡 中 | 增加 WebDriverWait 等待邏輯 |

### 技術挑戰

1. **定位器穩定性**
   - TronClass 使用絕對 XPath，極度脆弱
   - 需要設計更穩定的定位器策略（CSS Selector + 相對 XPath）

2. **平台邏輯差異**
   - 課程狀態識別邏輯可能完全不同
   - 考試流程可能有額外步驟

3. **測試覆蓋率**
   - 需要雙平台完整測試
   - 自動化測試腳本需要重新設計

---

## 🚀 下一步行動

### 立即行動項（等待用戶回覆）

1. **提供 elearning 平台資訊**
   - URL
   - 測試帳號或 HTML 結構

2. **確認改良方案**
   - 選擇方案 A（策略模式）或方案 B（配置驅動）

3. **確認時程需求**
   - 急需 (1-2 週) 或可等待 (1-2 個月)

### 後續工作（用戶決策後）

1. **Phase 1: 評估與設計**
   - 分析 elearning 平台 HTML 結構
   - 設計平台抽象層架構
   - 制定定位器配置規範

2. **Phase 2: 實作準備**
   - 建立平台目錄結構
   - 實作平台工廠模式
   - 建立抽象基類

3. **Phase 3-6**: 依照工作量評估表執行

---

## 📌 重要備註

### 向後相容性保證

**承諾**:
- ✅ TronClass 平台功能完全保留
- ✅ 現有用戶不受影響
- ✅ 原有配置檔格式不變（僅新增 `platform` 參數）
- ✅ 所有現有測試通過

### 禁止修改清單（遵循交接文檔規範）

**絕對不可修改**:
- ❌ `src/core/*` - 核心基礎設施
- ❌ `src/api/interceptors/visit_duration.py` - MitmProxy 攔截器
- ❌ `config/eebot.cfg` - 系統配置（僅可新增參數）

**可修改**:
- ✅ `src/pages/*` - 但需遵循 POM 模式
- ✅ `src/scenarios/*` - 但需保持原有介面

---

## 📊 工作時數記錄

| 階段 | 時間 | 活動 |
|-----|-----|------|
| 22:00-22:10 | 10 分鐘 | 閱讀交接文檔與背景理解 |
| 22:10-22:18 | 8 分鐘 | 分析掃描模組程式碼 |
| 22:18-22:22 | 4 分鐘 | 撰寫分析報告 |
| **總計** | **22 分鐘** | |

---

## 🏷️ 標籤

`#platform-migration` `#architecture-refactoring` `#multi-platform-support` `#tronclass` `#elearning` `#feasibility-study` `#strategy-pattern` `#config-driven` `#pom-pattern`

---

**工作狀態**: ⏸️ 等待用戶決策
**下次更新**: 待用戶提供 elearning 平台資訊後
**記錄完成時間**: 2025-11-30 22:22

---

*This work log was created with AI assistance (Claude Code CLI - Sonnet 4.5)*
