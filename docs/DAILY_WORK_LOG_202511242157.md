# EEBot 工作日誌 - 2025-11-24 21:57

> **工作階段**：課程配置優化與文檔規範討論
> **參與者**：wizard03 + Claude Code CLI (Sonnet 4.5)
> **專案版本**：v2.0.5 → v2.0.6 (規劃中)
> **專案代號**：Gleipnir (格萊普尼爾 / 縛狼鎖)

---

## 📋 本次工作概要

### 緊急修復（已完成）✅
1. **menu.py 智能推薦功能 stealth 提取步驟缺失**
   - 問題：i 選項中缺少瀏覽器自動化模式啟動步驟
   - 修復：添加 StealthExtractor 提取邏輯
   - 狀態：✅ 已完成

### 討論議題（規劃中）📝
1. **MitmProxy 精密攔截 - 按課程調整時間**
2. **課程流程標準化**
3. **MitmProxy 與課程連動**
4. **工作日誌檔名規範化**

---

## 🚨 緊急修復：menu.py stealth 提取步驟

### 問題描述

**發現者**：wizard03
**發現時間**：2025-11-24 21:30

**症狀**：
- menu.py 的智能推薦功能（i 選項）中沒有提取 stealth.min.js 的步驟
- 相關的產品化輸出訊息也沒有顯示
- 瀏覽器自動化模式沒有正確啟動

**根本原因**：
智能推薦功能直接從「載入配置」跳到「啟動瀏覽器」，完全跳過了提取 stealth.min.js 的步驟。

### 修復方案

**修改檔案**：`menu.py`

**修改位置**：Lines 221-264

**修改內容**：
1. 新增 `from src.utils.stealth_extractor import StealthExtractor` 導入
2. 在初始化步驟中添加「啟動瀏覽器自動化模式」
3. 更新初始化步驟編號：`[初始化 1/4]` → `[初始化 1/5]`

**修改後代碼**：
```python
# 1. 載入配置
print('[初始化 1/5] 載入配置...')
config = ConfigLoader('config/eebot.cfg')
config.load()
print('  ✓ 配置已載入')

# 2. 啟動瀏覽器自動化模式（提取 Stealth JS）
print('[初始化 2/5] 啟動瀏覽器自動化模式...')
extractor = StealthExtractor()
if not extractor.exists():
    extractor.run()
else:
    print('  ✓ 瀏覽器自動化模式就緒，跳過初始化')

# 3. 初始化核心元件（不使用 proxy）
print('[初始化 3/5] 初始化核心元件...')
driver_manager = DriverManager(config)
cookie_manager = CookieManager(config.get('cookies_file'))
print('  ✓ 核心元件已初始化')

# 4. 建立 Driver（停用 proxy）
print('[初始化 4/5] 啟動瀏覽器...')
driver = driver_manager.create_driver(use_proxy=False)
print('  ✓ 瀏覽器已啟動')

# 5. 初始化頁面物件
print('[初始化 5/5] 初始化頁面物件...')
login_page = LoginPage(driver, cookie_manager)
course_list_page = CourseListPage(driver)
print('  ✓ 頁面物件已初始化\n')
```

### 驗證結果

**預期輸出**：
```
[步驟 2/5] 正在啟動瀏覽器...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[初始化 1/5] 載入配置...
  ✓ 配置已載入
[初始化 2/5] 啟動瀏覽器自動化模式...
  ✓ 瀏覽器自動化模式就緒，跳過初始化
[初始化 3/5] 初始化核心元件...
  ✓ 核心元件已初始化
[初始化 4/5] 啟動瀏覽器...
  ✓ 瀏覽器已啟動
[初始化 5/5] 初始化頁面物件...
  ✓ 頁面物件已初始化
```

**狀態**：✅ 修復完成

---

## 💬 討論議題記錄

### 議題 1：MitmProxy 精密攔截 - 按課程調整時間

#### 需求背景

**提出者**：wizard03
**提出時間**：2025-11-24 21:35

**核心需求**：
- 目前系統統一為所有課程增加 **9000 秒**（150 分鐘）
- 不同課程可能需要不同的時長增加量
- 例如：
  - 某些短課程只需要 30 分鐘（1800 秒）
  - 某些長課程需要 180 分鐘（10800 秒）

#### 技術方案

**可行性評估**：✅ 完全可行

**推薦方案**：課程配置擴展 + 臨時檔案通訊

**方案 A：課程配置擴展（data/courses.json）**

```json
{
  "program_name": "資通安全學程課程(114年度)",
  "lesson_name": "個資保護認知宣導",
  "course_id": 365,
  "delay": 7.0,
  "visit_duration_increase": 5400,  // 新增：此課程增加 90 分鐘
  "description": "個資保護課程"
}
```

**優點**：
- ✅ 每個課程獨立設定時長
- ✅ 配置清晰易懂
- ✅ 向後相容（未設定則使用預設值 9000）

**方案 B：MitmProxy 與課程連動（進程間通訊）**

**技術挑戰**：MitmProxy 是獨立的 subprocess，需要進程間通訊（IPC）

**推薦方案**：臨時檔案通訊（data/current_course.json）

**實作步驟**：

**Step 1：主程式寫入當前課程資訊**

```python
# src/scenarios/course_learning.py
def _process_course(self, course: Dict[str, any]):
    # 在處理課程前，寫入當前課程資訊
    import json
    current_course_info = {
        'program_name': course.get('program_name'),
        'lesson_name': course.get('lesson_name'),
        'visit_duration_increase': course.get('visit_duration_increase', 9000)
    }

    with open('data/current_course.json', 'w', encoding='utf-8') as f:
        json.dump(current_course_info, f, ensure_ascii=False, indent=2)

    # 繼續原有流程...
```

**Step 2：MitmProxy 攔截器讀取配置**

```python
# src/api/interceptors/visit_duration.py
class VisitDurationInterceptor:
    def __init__(self):
        self.default_increase = 9000
        self.current_course_file = 'data/current_course.json'

    def _get_visit_duration_increase(self) -> int:
        """動態讀取當前課程的時長增加量"""
        try:
            import json
            import os

            if not os.path.exists(self.current_course_file):
                return self.default_increase

            with open(self.current_course_file, 'r', encoding='utf-8') as f:
                course_info = json.load(f)
                return course_info.get('visit_duration_increase', self.default_increase)
        except Exception as e:
            print(f'[警告] 讀取當前課程配置失敗: {e}，使用預設值')
            return self.default_increase

    def request(self, flow):
        if 'visit_duration' in flow.request.url:
            # 動態取得時長增加量
            increase_seconds = self._get_visit_duration_increase()

            # 修改參數...
```

**Step 3：清理機制**

```python
# main.py - 程式結束時清理
finally:
    if os.path.exists('data/current_course.json'):
        os.remove('data/current_course.json')
```

**影響範圍**：
- 修改檔案：4 個
  - `data/courses.json`（新增欄位）
  - `src/scenarios/course_learning.py`（寫入檔案）
  - `src/api/interceptors/visit_duration.py`（讀取配置）
  - `main.py`（清理臨時檔案）

**預估工作量**：2-3 小時

**優先級**：⭐⭐⭐⭐⭐（高）

**狀態**：📝 待實作

---

### 議題 2：課程流程標準化

#### 需求背景

**提出者**：wizard03
**提出時間**：2025-11-24 21:40

**核心需求**：
1. 將課程流程做成可以 **import / export** 的格式
2. 方便分享和備份課程設定
3. 掃描模組可以自動生成標準化的課程配置

**目前流程**（已標準化）：
```
我的課程 → 主課程（主題頁面）→ 副課程（副課程頁面）→ 主課程（主題頁面）
```

**位置**：`src/scenarios/course_learning.py:144-213`

#### 現況分析

**結論**：目前的流程已經是標準化的，但可以增加靈活性。

#### 改進方案

**方案 A：流程步驟參數化**（推薦）

```json
{
  "program_name": "資通安全學程課程(114年度)",
  "lesson_name": "個資保護認知宣導",
  "course_id": 365,
  "delay": 7.0,
  "navigation_flow": {  // 新增：導航流程配置
    "skip_back_to_course": false,      // 是否跳過返回主課程
    "skip_back_to_list": false,        // 是否跳過返回列表
    "custom_wait_after_lesson": 0      // 在副課程頁面額外等待時間
  },
  "description": "個資保護課程"
}
```

**優點**：
- ✅ 簡單易懂
- ✅ 滿足大部分需求
- ✅ 向後相容

**方案 B：流程模板化**（過度設計）

使用獨立的 `config/flow_templates.json` 定義流程模板。

**結論**：❌ 不推薦，除非有非常特殊的需求

**推薦**：採用方案 A（流程步驟參數化）

**優先級**：⭐⭐⭐（中）

**狀態**：📝 待實作

---

### 議題 3：課程配置 Import / Export 系統

#### 需求背景

**提出者**：wizard03
**提出時間**：2025-11-24 21:45

**核心需求**：
1. 掃描模組先做預處理
2. 列出需要新增的課程清單
3. 生成標準化的課程配置（可直接匯入）
4. 形成完整的「掃描 → 配置生成 → 匯入」工作流

#### 系統架構

```
┌─────────────────────────────────────────────────────────────┐
│                    課程配置標準化系統                          │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 掃描模組      │    │ 匯出模組      │    │ 匯入模組      │
├──────────────┤    ├──────────────┤    ├──────────────┤
│ - 掃描課程    │    │ - 讀取 JSON  │    │ - 驗證格式    │
│ - 比對現有    │───>│ - 生成配置    │───>│ - 合併配置    │
│ - 列出差異    │    │ - 儲存檔案    │    │ - 寫入 JSON   │
└──────────────┘    └──────────────┘    └──────────────┘
        │                     │                     │
        └─────────────────────┴─────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ courses.json     │
                    │ (標準化格式 v2)   │
                    └──────────────────┘
```

#### 標準化課程配置格式 v2.0

```json
{
  "description": "課程資料配置檔",
  "version": "2.0",
  "format_version": "2.0",
  "courses": [
    {
      // 基本資訊
      "program_name": "資通安全學程課程(114年度)",
      "lesson_name": "個資保護認知宣導",
      "course_id": 365,
      "course_type": "course",  // "course" | "exam"
      "description": "個資保護課程",

      // 時間配置
      "delay": 7.0,
      "visit_duration_increase": 5400,  // 90 分鐘（秒）

      // 流程配置（可選）
      "navigation_flow": {
        "skip_back_to_course": false,
        "skip_back_to_list": false,
        "custom_wait_after_lesson": 0
      },

      // 截圖配置（可選）
      "enable_screenshot": false,

      // 自動答題配置（僅考試）
      "enable_auto_answer": false,

      // 元數據（自動生成）
      "metadata": {
        "created_at": "2025-11-24T21:57:00",
        "created_by": "scan_module",
        "source": "auto_scan",
        "course_url": "https://..."
      }
    }
  ]
}
```

#### 功能模組設計

**模組 1：CourseScanner（掃描與比對）**

**檔案位置**：`src/utils/course_scanner.py`（新增）

```python
class CourseScanner:
    """課程掃描與比對模組"""

    def scan_in_progress_courses(self) -> List[Dict]:
        """掃描所有「修習中」的課程"""
        pass

    def compare_with_existing(self, scanned, existing) -> Dict:
        """
        比對掃描結果與現有配置

        Returns:
            {
                'new_courses': [],      # 需要新增的課程
                'existing_courses': [], # 已配置的課程
                'updated_courses': []   # 需要更新的課程
            }
        """
        pass

    def generate_config(self, courses, template='default') -> Dict:
        """生成標準化配置"""
        pass
```

**模組 2：ConfigIO（匯入/匯出）**

**檔案位置**：`src/utils/config_io.py`（新增）

```python
class ConfigIO:
    """課程配置匯入/匯出模組"""

    def export_courses(self, output_file='courses_export.json',
                       filter_type=None) -> bool:
        """
        匯出課程配置

        Args:
            output_file: 匯出檔案名稱
            filter_type: 'course' | 'exam' | None（全部）
        """
        pass

    def import_courses(self, input_file, mode='merge') -> bool:
        """
        匯入課程配置

        Args:
            input_file: 匯入檔案名稱
            mode: 'merge' | 'replace' | 'append'
                - merge: 智能合併（去重）
                - replace: 完全取代
                - append: 直接附加
        """
        pass

    def validate_format(self, config_data) -> Tuple[bool, List[str]]:
        """驗證配置格式"""
        pass
```

**影響範圍**：
- 新增檔案：2 個（`course_scanner.py`, `config_io.py`）
- 修改檔案：1 個（`menu.py` - 添加 import/export 選項）

**預估工作量**：5-7 小時

**優先級**：⭐⭐⭐⭐（高）

**狀態**：📝 待實作

---

### 議題 4：工作日誌檔名規範化

#### 需求背景

**提出者**：wizard03
**提出時間**：2025-11-24 21:50

**問題**：
1. 一天可能有多次記錄，舊格式 `DAILY_WORK_LOG_yyyymmdd.md` 會造成檔名衝突
2. 曾出現 `DAILY_WORK_LOG_20250117_v2.md` 這種不一致的命名
3. 檔案過長時沒有自動分段機制

#### 新規範

**檔名格式**：`DAILY_WORK_LOG_yyyymmddhhmm.md`

**格式說明**：
- **yyyy**：年份（4位數）
- **mm**：月份（2位數，01-12）
- **dd**：日期（2位數，01-31）
- **hh**：小時（2位數，00-23）
- **mm**：分鐘（2位數，00-59）

**範例**：
- `DAILY_WORK_LOG_202511241430.md`（2025年11月24日 14:30）
- `DAILY_WORK_LOG_202511241445.md`（2025年11月24日 14:45）

**分段規則**：
- 觸發條件：單一檔案超過 **500 行**或 **20KB**
- 分段格式：`DAILY_WORK_LOG_yyyymmddhhmm-{num}.md`
- 範例：
  - `DAILY_WORK_LOG_202511241430-1.md`（第1段）
  - `DAILY_WORK_LOG_202511241430-2.md`（第2段）
  - `DAILY_WORK_LOG_202511241430-3.md`（第3段）

**分段原則**：
- 在合適的章節結束處分段（不要在段落中間切斷）
- 每個分段檔案開頭包含導航連結
- 分段檔案末尾包含「續下一檔案」連結

**分段範例**：

```markdown
# EEBot 工作日誌 - 2025-11-24 14:30 (第1段)

> **分段資訊**：本日誌共 3 段
> - 📄 當前：第 1 段
> - ➡️ 下一段：[DAILY_WORK_LOG_202511241430-2.md](./DAILY_WORK_LOG_202511241430-2.md)

---

[工作日誌內容...]

---

**本段結束，請繼續閱讀下一段**：[DAILY_WORK_LOG_202511241430-2.md](./DAILY_WORK_LOG_202511241430-2.md)
```

#### 現有檔案分析

**檢查結果**：
```
✅ 日期正確的檔案（舊格式 yyyymmdd）：
   2025年1月：
   - DAILY_WORK_LOG_20250116.md  (1月16日 - 截圖功能實作)
   - DAILY_WORK_LOG_20250117.md  (1月17日 - 一鍵自動執行 + 跨平台字體)
   - DAILY_WORK_LOG_20250117_v2.md  (1月17日 - 時間統計系統) ← 同一天第2次記錄

   2025年11月：
   - DAILY_WORK_LOG_20251114.md  (11月14日 - 早期開發)
   - DAILY_WORK_LOG_20251115.md  (11月15日 - 自動答題系統)
   - DAILY_WORK_LOG_20251116.md  (11月16日 - 安全性增強)
   - DAILY_WORK_LOG_20251117.md  (11月17日 - 穩定性優化 v2.0.5)

⚠️ 發現的問題：
   - DAILY_WORK_LOG_20250117_v2.md 使用 _v2 後綴
   - 原因：1月17日有 2 次工作記錄，舊格式 yyyymmdd 無法區分
   - 這正好證明了新格式 yyyymmddhhmm 的必要性！
```

**處理建議**：
- ✅ **保留所有舊格式檔案**（不重新命名，避免破壞歷史記錄）
- ✅ **從今天開始使用新格式**（已生效）
- ⚠️ **可選**：將 `_v2` 檔案重新命名為 `202501171800.md`（假設時間）
- ✅ **在文檔中註明新舊格式的區別**

**優先級**：⭐⭐⭐⭐⭐（高）

**狀態**：✅ 規範已制定，立即生效

---

## 📊 實作計劃總覽

### Phase 1：基礎架構（優先級：⭐⭐⭐⭐⭐）

| # | 任務 | 狀態 | 預估時間 | 影響範圍 |
|---|------|------|---------|---------|
| 1 | menu.py stealth 提取步驟 | ✅ 已完成 | - | 1 個檔案 |
| 2 | 課程配置擴展（visit_duration_increase） | 📝 待實作 | 1 小時 | 1 個檔案 |
| 3 | MitmProxy 動態配置（臨時檔案通訊） | 📝 待實作 | 2 小時 | 3 個檔案 |

**總計**：3 小時 / 4 個檔案

### Phase 2：掃描與比對模組（優先級：⭐⭐⭐⭐）

| # | 任務 | 狀態 | 預估時間 | 影響範圍 |
|---|------|------|---------|---------|
| 4 | CourseScanner 實作 | 📝 待實作 | 3 小時 | 新增 1 個檔案 |
| 5 | 智能推薦增強（整合掃描比對） | 📝 待實作 | 1 小時 | 修改 1 個檔案 |

**總計**：4 小時 / 2 個檔案

### Phase 3：匯入/匯出系統（優先級：⭐⭐⭐⭐）

| # | 任務 | 狀態 | 預估時間 | 影響範圍 |
|---|------|------|---------|---------|
| 6 | ConfigIO 實作 | 📝 待實作 | 2 小時 | 新增 1 個檔案 |
| 7 | Menu 整合（添加 import/export 選項） | 📝 待實作 | 1 小時 | 修改 1 個檔案 |

**總計**：3 小時 / 2 個檔案

### Phase 4：流程參數化（優先級：⭐⭐⭐）

| # | 任務 | 狀態 | 預估時間 | 影響範圍 |
|---|------|------|---------|---------|
| 8 | navigation_flow 實作 | 📝 待實作 | 2 小時 | 修改 2 個檔案 |
| 9 | Scenario 整合（支援自定義流程） | 📝 待實作 | 1 小時 | 修改 1 個檔案 |

**總計**：3 小時 / 3 個檔案

---

## 📋 待確認問題

### Q1：實作順序？
建議按照 Phase 順序實作，您同意嗎？

### Q2：今天實作範圍？
- **選項 A**：只實作 Phase 1（基礎架構）- 3 小時
- **選項 B**：實作 Phase 1 + Phase 2（掃描模組）- 7 小時
- **選項 C**：先討論清楚所有細節，今天不實作 ✅ **已選擇**

### Q3：匯入/匯出的檔案格式？
- JSON？
- CSV？
- 兩者都支援？

### Q4：掃描模組的預設值？
當掃描到新課程時，預設的 `visit_duration_increase` 應該是多少？
- 9000 秒（150 分鐘）？
- 根據課程類型自動判斷？

---

## 🎯 決策記錄

### 決策 1：工作日誌檔名規範
- **決策時間**：2025-11-24 21:50
- **決策內容**：採用新格式 `DAILY_WORK_LOG_yyyymmddhhmm.md`
- **生效時間**：立即生效（從本檔案開始）
- **狀態**：✅ 已通過

### 決策 2：今天工作範圍
- **決策時間**：2025-11-24 21:55
- **決策內容**：今天只討論不實作，將討論內容記錄到文檔
- **狀態**：✅ 已通過

---

## 📁 相關檔案

### 修改的檔案
- `menu.py:221-264` - 添加 stealth 提取步驟

### 新增的檔案
- `docs/DAILY_WORK_LOG_202511242157.md` - 本工作日誌

### 待修改的檔案（Phase 1）
- `data/courses.json` - 添加 `visit_duration_increase` 欄位
- `src/scenarios/course_learning.py` - 寫入當前課程資訊
- `src/scenarios/exam_learning.py` - 寫入當前課程資訊
- `src/api/interceptors/visit_duration.py` - 讀取動態配置
- `main.py` - 清理臨時檔案

### 待新增的檔案（Phase 2-4）
- `src/utils/course_scanner.py` - 掃描與比對模組
- `src/utils/config_io.py` - 匯入/匯出模組

---

## 🔗 參考資料

### 相關文檔
- [CHANGELOG.md](../CHANGELOG.md) - 修改歷史
- [AI_ASSISTANT_GUIDE.md](./AI_ASSISTANT_GUIDE.md) - AI 助手指南
- [CLAUDE_CODE_HANDOVER.md](./CLAUDE_CODE_HANDOVER.md) - Claude Code 交接文檔

### 工作日誌歷史
- `DAILY_WORK_LOG_20250117.md` - 完整時間統計系統
- `DAILY_WORK_LOG_20250116.md` - 截圖功能實作
- `DAILY_WORK_LOG_20251117.md` - 穩定性與配置優化
- `DAILY_WORK_LOG_20251116.md` - 安全性增強與智能推薦修復
- `DAILY_WORK_LOG_20251115.md` - 自動答題系統完整實作

---

## 📝 備註

### 重要提醒
1. **MitmProxy 動態配置**：需要仔細測試進程間通訊的穩定性
2. **課程配置格式**：保持向後相容非常重要
3. **掃描模組**：需要考慮網頁結構變化的適應性
4. **檔案分段**：確保分段點在合適的位置，不破壞內容完整性

### 技術債務
- 無（本次討論）

---

**工作日誌完成時間**：2025-11-24 22:00
**下次工作計劃**：實作 Phase 1（基礎架構）
**預估開始時間**：待確認

---

**記錄者**：Claude Code CLI (Sonnet 4.5)
**複核者**：wizard03
