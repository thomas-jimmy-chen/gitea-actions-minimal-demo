# 混合式時長發送功能使用指南

> **版本**: 1.0
> **建立日期**: 2025-12-16
> **功能代號**: `h` - 混合式時長發送

---

## 📋 功能概述

**混合式時長發送** 是一個創新的時長管理功能，結合了 Selenium Web 掃描與 API 直接發送的優勢，實現：

1. ✅ **精確掃描**：從網頁上提取每個主課程的已閱讀時數
2. ✅ **靈活排程**：允許用戶選擇要發送時長的課程
3. ✅ **API 發送**：快速發送時長（無需進入每個課程）
4. ✅ **驗證機制**：自動重新掃描並計算時長增加量

---

## 🔧 完整流程

### 流程圖

```
┌─────────────────────────────────────────────┐
│  步驟 1: 登入系統                            │
│  • 自動登入（最多3次重試）                    │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  步驟 2: 第一次掃描                          │
│  • 掃描所有「修習中」的課程計畫                │
│  • 進入每個課程計畫詳情頁                     │
│  • 從頁面提取「累積觀看時長」（使用 Web）      │
│  • 記錄每個課程的當前時數                     │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  步驟 3: 提取用戶資訊                        │
│  • 提取用戶 ID、姓名、部門等資訊               │
│  • 提取 Session Cookie（準備 API 調用）      │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  步驟 4: 瀏覽器停止在「我的課程」頁面          │
│  ⏸️  等待用戶操作：                           │
│  • 開啟另一個終端                             │
│  • 執行 python menu.py                       │
│  • 選擇課程加入排程                           │
│  • 選擇 "s. 儲存排程"                         │
│  • 返回第一個終端按 Enter 繼續                │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  步驟 5: API 發送時長                        │
│  • 讀取 data/schedule.json                   │
│  • 為每個已排程課程發送時長                   │
│  • 使用 POST /statistics/api/user-visits     │
│  • 時長增加量：config 中的 visit_duration_increase │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  步驟 6: 第二次掃描（驗證）                   │
│  • 重新掃描所有課程的已閱讀時數                │
│  • 計算每個課程的時長增加量                   │
│  • 顯示詳細的時長變化分析                     │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  完成！                                      │
│  • 顯示時長變化報告                           │
│  • 瀏覽器保持開啟（可手動檢查結果）            │
└─────────────────────────────────────────────┘
```

---

## 🚀 使用步驟

### **準備工作**

1. **確認配置檔案**
   ```bash
   # 檢查 config/eebot.cfg
   [SETTINGS]
   user_name = your_username
   password = your_password
   visit_duration_increase = 9000  # 發送的時長增加量（秒）
   ```

2. **確認課程資料**
   ```bash
   # 檢查 data/courses.json 包含所有課程
   ```

---

### **執行流程**

#### **終端 1：執行混合式時長發送**

```bash
cd D:\Dev\eebot
python menu.py
```

選擇：
```
請輸入選項: h
```

**步驟 1-3 會自動執行**：
- ✅ 登入系統
- ✅ 第一次掃描（記錄當前時數）
- ✅ 提取用戶資訊

**步驟 4：等待排程**

當看到以下訊息時：
```
[步驟 4/6] 瀏覽器已停止在 "我的課程" 頁面
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏸️  請在另一個終端執行：
   python menu.py
   選擇課程加入排程，然後選擇 "s. 儲存排程"
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 排程完成後，按 Enter 繼續...
```

**不要按 Enter！** 先開啟另一個終端。

---

#### **終端 2：加入排程**

```bash
cd D:\Dev\eebot
python menu.py
```

**操作步驟**：
1. 選擇要發送時長的課程（輸入數字）
2. 可選擇多個課程（重複輸入數字）
3. 輸入 `s` 儲存排程
4. 輸入 `q` 離開

**範例**：
```
請輸入選項: 1
✓ 已加入排程: 課程計畫1 - 課程1

請輸入選項: 3
✓ 已加入排程: 課程計畫3 - 課程3

請輸入選項: s
✓ 排程已儲存至 data/schedule.json
✓ 共 2 個課程已加入排程

請輸入選項: q
再見！
```

---

#### **終端 1：繼續執行**

返回終端 1，按 `Enter` 繼續。

**步驟 5-6 會自動執行**：
- ✅ 讀取排程並發送時長
- ✅ 第二次掃描（驗證時數）
- ✅ 顯示時長變化分析

---

## 📊 輸出範例

### **第一次掃描結果**

```
[步驟 2/6] 第一次掃描 - 記錄所有課程的當前時數...
  🔍 正在掃描課程計畫...
  ✅ 找到 5 個課程計畫

  [1/5] 掃描課程計畫: 個資保護認知宣導(114年度)
      已閱讀時數: 120 分鐘

  [2/5] 掃描課程計畫: 永續金融與環境教育(114年度)
      已閱讀時數: 85 分鐘

  📋 第一次掃描結果
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  • 個資保護認知宣導(114年度)
      時數: 120 分鐘 | 掃描時間: 2025-12-16 14:30:00
  • 永續金融與環境教育(114年度)
      時數: 85 分鐘 | 掃描時間: 2025-12-16 14:32:00
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### **API 發送結果**

```
[步驟 5/6] 讀取排程並發送時長...
  ✅ 載入排程: 2 個課程

  📤 開始發送時長（增加 9000 秒 = 150 分鐘）...
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  [1/2] 個資保護認知宣導(114年度) - 個資保護課程
      ✅ 發送成功 (+150 分鐘)

  [2/2] 永續金融與環境教育(114年度) - 永續金融課程
      ✅ 發送成功 (+150 分鐘)

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📊 發送結果: ✅ 成功 2 個, ❌ 失敗 0 個
```

---

### **時長變化分析**

```
📊 時長變化分析
============================================================

✅ 個資保護認知宣導(114年度)
   掃描前: 120 分鐘
   掃描後: 270 分鐘
   增加量: 150 分鐘 (9000 秒)

✅ 永續金融與環境教育(114年度)
   掃描前: 85 分鐘
   掃描後: 235 分鐘
   增加量: 150 分鐘 (9000 秒)

============================================================
✅ 混合式時長發送完成！
============================================================
```

---

## ⚙️ 配置說明

### **調整發送的時長增加量**

編輯 `config/eebot.cfg`：

```ini
[SETTINGS]
# 每次發送增加的時長（秒）
visit_duration_increase = 9000  # 9000 秒 = 150 分鐘 = 2.5 小時
```

**常用設定**：
- `3600` = 1 小時
- `5400` = 1.5 小時
- `7200` = 2 小時
- `9000` = 2.5 小時（預設）
- `10800` = 3 小時

---

## ❓ 常見問題

### **Q1: 為什麼需要開兩個終端？**

**A**: 因為第一個終端的瀏覽器需要保持在「我的課程」頁面，不能關閉。同時，你需要使用 `menu.py` 來選擇要發送時長的課程。兩個終端可以同時操作，互不干擾。

---

### **Q2: 如果第一次掃描沒有找到課程時數怎麼辦？**

**A**: 可能的原因：
1. 課程計畫頁面沒有顯示「累積觀看時長」
2. 頁面載入不完整

**解決方案**：
- 檢查課程計畫詳情頁是否有時數顯示
- 嘗試手動進入一個課程，確認頁面結構
- 修改 `_extract_duration_from_page()` 方法的正則表達式

---

### **Q3: API 發送失敗怎麼辦？**

**A**: 可能的原因：
1. Session Cookie 過期
2. 用戶資訊提取失敗
3. 網路問題

**解決方案**：
- 重新執行 `h` 功能
- 檢查是否成功登入
- 檢查 `config/eebot.cfg` 配置是否正確

---

### **Q4: 第二次掃描的時數沒有增加？**

**A**: 可能的原因：
1. API 發送失敗（但沒有報錯）
2. 伺服器端延遲更新
3. 課程 ID 不正確

**解決方案**：
- 等待 1-2 分鐘後手動刷新課程頁面
- 檢查伺服器端是否真的收到時長資料
- 檢查排程中的 `course_id` 是否正確

---

### **Q5: 可以不開第二個終端嗎？**

**A**: 理論上可以，但不推薦。如果你已經提前準備好 `data/schedule.json`，可以跳過步驟 4，直接按 Enter 繼續。但這樣就失去了靈活選擇課程的優勢。

---

## 🔧 技術細節

### **時數提取策略**

從課程計畫詳情頁提取時數，使用以下正則表達式：

```python
# 策略 1: "累積觀看時長 120 分鐘"
match = re.search(r'累積觀看時長[：:\s]*(\d+)\s*分鐘', page_text)

# 策略 2: "已觀看 120 分鐘"
match = re.search(r'已觀看[：:\s]*(\d+)\s*分鐘', page_text)
```

如果頁面上的文字格式不同，可以修改 `src/scenarios/hybrid_duration_send.py` 的 `_extract_duration_from_page()` 方法。

---

### **API 端點**

```
POST https://elearn.post.gov.tw/statistics/api/user-visits
Content-Type: application/json

{
  "user_id": "19688",
  "org_id": "1",
  "visit_duration": 9000,  // 秒
  "course_id": "465",
  "course_name": "課程名稱",
  ...
}

回應: 204 No Content
```

---

## 📝 檔案說明

### **核心檔案**

| 檔案 | 說明 |
|------|------|
| `src/scenarios/hybrid_duration_send.py` | 混合式時長發送場景（核心邏輯） |
| `menu.py` | 主選單（第 1537-1548 行：`hybrid_scan()` 方法） |
| `src/api/visit_duration_api.py` | API 客戶端（發送時長） |
| `data/schedule.json` | 排程檔案（記錄要發送時長的課程） |
| `config/eebot.cfg` | 配置檔案（時長增加量設定） |

---

## 🎯 最佳實踐

1. **第一次使用時，先測試單個課程**
   - 只加入一個課程到排程
   - 確認時長是否成功增加
   - 再批量處理多個課程

2. **定期檢查排程檔案**
   - `data/schedule.json` 會被覆蓋
   - 如果需要保留，請手動備份

3. **觀察第二次掃描結果**
   - 如果時數沒有增加，立即停止
   - 檢查 API 發送是否真的成功
   - 避免重複發送

4. **合理設定時長增加量**
   - 不要設定過大的值（例如 10 小時）
   - 建議每次 1-3 小時
   - 可以分多次執行

---

## 📚 相關文檔

- **API 直接調用模式**: `docs/REFACTORING_PROPOSAL_API_DIRECT_MODE.md`
- **Burp Suite 分析**: `BURP_SUITE_ANALYSIS_INDEX.md`
- **一般課程 API 自動化**: `GENERAL_COURSE_API_AUTOMATION.md`
- **配置管理指南**: `docs/CONFIGURATION_MANAGEMENT_GUIDE.md`

---

## 🐛 問題回報

如果遇到問題，請提供以下資訊：

1. **完整的錯誤訊息**（截圖或文字）
2. **執行步驟**（在哪個步驟出錯）
3. **配置檔案**（`config/eebot.cfg` 的相關部分）
4. **排程檔案**（`data/schedule.json`）
5. **終端輸出**（完整的執行日誌）

---

**版本歷史**:
- v1.0 (2025-12-16) - 初版發布

**維護者**: wizard03
**專案代號**: Gleipnir
