# 待辦事項：混合執行模式 (v2.2.0)

**功能名稱**: 混合執行模式（Selenium + API）
**版本**: 2.2.0
**優先級**: 🔥 **第一優先**
**狀態**: 📋 **規劃中**
**預計開發時間**: 11 工作日
**開始日期**: TBD
**目標完成日期**: TBD

---

## 📋 任務總覽

### 開發階段

- [ ] **Phase 1**: 通過條件提取模組 (2-3 天)
- [ ] **Phase 2**: 時長模式選擇器 (1 天)
- [ ] **Phase 3**: 訪問時長 API 客戶端 (2 天)
- [ ] **Phase 4**: 混合執行場景 (3-4 天)
- [ ] **Phase 5**: 整合測試與優化 (2-3 天)

**總計**: 10-13 天（平均 11 天）

---

## Phase 1: 通過條件提取模組 (2-3 天)

**目標**: 實作 `PassRequirementsExtractor` 類，批次提取所有課程計畫的通過條件

### 任務清單

- [ ] **1.1 創建基礎類結構** (2 小時)
  - [ ] 在 `src/extractors/` 創建 `pass_requirements_extractor.py`
  - [ ] 定義類架構和方法簽名
  - [ ] 設定日誌機制
  - [ ] 定義資料結構（返回格式）

- [ ] **1.2 實作批次提取邏輯** (4 小時)
  - [ ] 整合 `CourseListPage` 進行頁面導航
  - [ ] 實作智能點擊機制（滾動 + JS 點擊備援）
  - [ ] 批次查找所有 `module-*` 元素
  - [ ] XPath 定位通過條件元素

- [ ] **1.3 實作文字解析** (2 小時)
  - [ ] Regex 提取觀看時長: `r'觀看時長(\d+)分鐘'`
  - [ ] Regex 提取測驗成績: `r'測驗成績達(\d+)分'`
  - [ ] 處理特殊格式（如"參考資料"）
  - [ ] 錯誤處理和日誌記錄

- [ ] **1.4 實作快取機制** (3 小時)
  - [ ] 創建快取檔案結構
  - [ ] 實作快取讀取/寫入
  - [ ] 實作快取有效期檢查
  - [ ] 配置項整合（`cache_requirements`, `cache_expiry_hours`）

- [ ] **1.5 單元測試** (3 小時)
  - [ ] 測試批次提取邏輯
  - [ ] 測試文字解析（8 種格式）
  - [ ] 測試快取機制
  - [ ] 測試錯誤處理

- [ ] **1.6 文檔** (1 小時)
  - [ ] Docstring 完善
  - [ ] 使用範例
  - [ ] API 文檔更新

**預估時間**: 15 小時（2 天）

---

## Phase 2: 時長模式選擇器 (1 天)

**目標**: 實作 `DurationModeSelector` 類，支援三種時長模式

### 任務清單

- [ ] **2.1 創建基礎類結構** (1 小時)
  - [ ] 在 `src/selectors/` 創建 `duration_mode_selector.py`
  - [ ] 定義三種模式常數（FIXED, REQUIRED, AUTO）
  - [ ] 設定配置載入

- [ ] **2.2 實作時長計算邏輯** (3 小時)
  - [ ] 固定模式：返回 `fixed_duration_minutes`
  - [ ] 要求模式：從提取結果獲取 `required_duration`
  - [ ] 自動模式：`required_duration + duration_buffer_minutes`
  - [ ] 處理缺失值（使用預設值）

- [ ] **2.3 配置項整合** (1 小時)
  - [ ] 讀取 `duration_mode` 配置
  - [ ] 讀取 `fixed_duration_minutes` 配置
  - [ ] 讀取 `duration_buffer_minutes` 配置
  - [ ] 配置驗證

- [ ] **2.4 單元測試** (2 小時)
  - [ ] 測試三種模式
  - [ ] 測試邊界情況
  - [ ] 測試配置載入

- [ ] **2.5 文檔** (1 小時)
  - [ ] Docstring
  - [ ] 使用範例
  - [ ] 配置說明

**預估時間**: 8 小時（1 天）

---

## Phase 3: 訪問時長 API 客戶端 (2 天)

**目標**: 實作 `VisitDurationClient` 類，透過 API 提交觀看時長

### 任務清單

- [ ] **3.1 API 端點研究** (2 小時)
  - [ ] 分析 `POST /statistics/api/user-visits` 請求格式
  - [ ] 確認必要欄位（user_id, course_id, duration, etc.）
  - [ ] 確認回應格式
  - [ ] 記錄 API 文檔

- [ ] **3.2 創建基礎類結構** (1 小時)
  - [ ] 在 `src/api/` 創建 `visit_duration_client.py`
  - [ ] 定義類架構
  - [ ] 設定 requests session

- [ ] **3.3 實作用戶資訊提取** (3 小時)
  - [ ] 創建 `UserInfoExtractor` 類
  - [ ] 從頁面提取 user_id
  - [ ] 從頁面提取 org_id
  - [ ] 提取其他必要欄位
  - [ ] 快取用戶資訊

- [ ] **3.4 實作 API 提交邏輯** (3 小時)
  - [ ] 構造 JSON payload
  - [ ] POST 請求實作
  - [ ] Cookie 管理
  - [ ] Headers 設定

- [ ] **3.5 錯誤處理與重試** (2 小時)
  - [ ] HTTP 錯誤處理
  - [ ] 網路逾時處理
  - [ ] 自動重試機制（最多 3 次）
  - [ ] 日誌記錄

- [ ] **3.6 單元測試** (2 小時)
  - [ ] 測試 API 調用
  - [ ] 測試錯誤處理
  - [ ] 測試重試機制
  - [ ] Mock 測試

- [ ] **3.7 文檔** (1 小時)
  - [ ] API 文檔
  - [ ] 使用範例
  - [ ] 故障排除

**預估時間**: 14 小時（2 天）

---

## Phase 4: 混合執行場景 (3-4 天)

**目標**: 實作 `HybridExecutionScenario` 類，整合所有模組

### 任務清單

- [ ] **4.1 創建基礎類結構** (2 小時)
  - [ ] 在 `src/scenarios/` 創建 `hybrid_execution_scenario.py`
  - [ ] 定義類架構
  - [ ] 整合所有模組

- [ ] **4.2 實作登入與提取流程** (4 小時)
  - [ ] Selenium 登入
  - [ ] 調用 `PassRequirementsExtractor`
  - [ ] 儲存提取結果
  - [ ] 錯誤處理

- [ ] **4.3 實作課程處理流程** (5 小時)
  - [ ] 遍歷課程列表
  - [ ] 選擇觀看時長（`DurationModeSelector`）
  - [ ] API 提交時長（`VisitDurationClient`）
  - [ ] 記錄處理結果

- [ ] **4.4 實作考試處理流程** (4 小時)
  - [ ] 檢測課程是否有考試
  - [ ] 自動匹配題庫（基於課程主題）
  - [ ] 調用自動答題系統
  - [ ] 考試結果記錄

- [ ] **4.5 實作進度追蹤** (2 小時)
  - [ ] 顯示處理進度
  - [ ] 統計成功/失敗數量
  - [ ] 生成執行報告

- [ ] **4.6 配置項整合** (2 小時)
  - [ ] 讀取 `hybrid_mode_enabled` 配置
  - [ ] 整合所有混合模式配置
  - [ ] 配置驗證

- [ ] **4.7 單元測試** (4 小時)
  - [ ] 測試完整流程
  - [ ] 測試各個模組整合
  - [ ] 測試錯誤處理
  - [ ] 端到端測試

- [ ] **4.8 文檔** (2 小時)
  - [ ] 完整流程說明
  - [ ] 使用範例
  - [ ] 故障排除

**預估時間**: 25 小時（3-4 天）

---

## Phase 5: 整合測試與優化 (2-3 天)

**目標**: 完整測試、性能優化、文檔完善

### 任務清單

- [ ] **5.1 端到端測試** (4 小時)
  - [ ] 完整執行流程測試
  - [ ] 多種配置組合測試
  - [ ] 邊界情況測試
  - [ ] 錯誤恢復測試

- [ ] **5.2 性能基準測試** (3 小時)
  - [ ] 測量執行時間
  - [ ] 與傳統模式比較
  - [ ] 資源消耗分析
  - [ ] 性能報告生成

- [ ] **5.3 錯誤處理完善** (3 小時)
  - [ ] 檢查所有錯誤路徑
  - [ ] 完善錯誤訊息
  - [ ] 添加恢復機制
  - [ ] 日誌完善

- [ ] **5.4 程式碼審查與重構** (3 小時)
  - [ ] 程式碼風格檢查
  - [ ] 重複代碼消除
  - [ ] 命名規範統一
  - [ ] 註釋完善

- [ ] **5.5 文檔更新** (4 小時)
  - [ ] README 更新
  - [ ] API 文檔完善
  - [ ] 使用指南更新
  - [ ] 故障排除指南

- [ ] **5.6 範例和教學** (2 小時)
  - [ ] 創建使用範例
  - [ ] 配置範例
  - [ ] 常見場景演示

- [ ] **5.7 版本發布準備** (1 小時)
  - [ ] CHANGELOG 更新
  - [ ] 版本號更新
  - [ ] 發布說明撰寫

**預估時間**: 20 小時（2-3 天）

---

## 📊 進度追蹤

### 整體進度

- [x] **前期準備**: 實驗驗證 ✅
- [ ] **Phase 1**: 通過條件提取模組 (0%)
- [ ] **Phase 2**: 時長模式選擇器 (0%)
- [ ] **Phase 3**: 訪問時長 API 客戶端 (0%)
- [ ] **Phase 4**: 混合執行場景 (0%)
- [ ] **Phase 5**: 整合測試與優化 (0%)

**總進度**: 0/5 階段完成

### 時間統計

| 階段 | 預估時間 | 實際時間 | 差異 |
|------|---------|---------|------|
| Phase 1 | 15h (2d) | - | - |
| Phase 2 | 8h (1d) | - | - |
| Phase 3 | 14h (2d) | - | - |
| Phase 4 | 25h (3-4d) | - | - |
| Phase 5 | 20h (2-3d) | - | - |
| **總計** | **82h (10-13d)** | **-** | **-** |

---

## 🎯 里程碑

- [ ] **M1**: Phase 1 完成（通過條件提取可用）
- [ ] **M2**: Phase 1-3 完成（核心功能完成）
- [ ] **M3**: Phase 1-4 完成（混合執行可用）
- [ ] **M4**: Phase 5 完成（v2.2.0 發布）

---

## 📝 依賴項

### 必要依賴

- [x] ✅ 實驗驗證完成（XPath 提取 100% 成功）
- [x] ✅ API 端點確認（`GET /api/my-courses`）
- [ ] ⏳ 訪問時長 API 格式確認（`POST /statistics/api/user-visits`）
- [ ] ⏳ 用戶資訊提取方法確認

### 程式庫依賴

- [x] ✅ `selenium` - 已安裝
- [x] ✅ `requests` - 已安裝
- [x] ✅ `urllib3` - 已安裝
- [ ] ⏳ 其他依賴（待確認）

---

## ⚠️ 風險與挑戰

| 風險 | 影響 | 機率 | 應對措施 | 狀態 |
|------|------|------|---------|------|
| XPath 提取失敗 | 中 | 低 | 錯誤處理 + 降級方案 | 📋 規劃中 |
| API 格式變更 | 高 | 低 | 版本檢測 + 相容性處理 | 📋 規劃中 |
| 用戶資訊提取困難 | 中 | 中 | 多種提取策略 | 📋 規劃中 |
| 頁面結構變更 | 中 | 中 | 定期測試 + 維護 | 📋 規劃中 |
| 性能未達預期 | 低 | 低 | 優化與調整 | 📋 規劃中 |

---

## 📚 相關文檔

- [課程通過條件實驗總結](./課程通過條件實驗總結.md)
- [CLAUDE_CODE_HANDOVER-2.md](./CLAUDE_CODE_HANDOVER-2.md) - AI 交接文檔
- [CONFIGURATION_MANAGEMENT_GUIDE.md](./CONFIGURATION_MANAGEMENT_GUIDE.md) - 配置管理指南
- [CHANGELOG.md](../CHANGELOG.md) - 更新日誌 (v2.0.9)

---

## 👥 團隊分工

**開發**: wizard03 (with Claude Code CLI)
**測試**: wizard03
**文檔**: Claude Code CLI (Sonnet 4.5)
**審查**: TBD

---

## 📅 時間線

| 日期 | 里程碑 | 狀態 |
|------|--------|------|
| 2025-12-05 | 實驗驗證完成 | ✅ 完成 |
| TBD | 開始開發 (Phase 1) | ⏳ 待開始 |
| TBD | M1: Phase 1 完成 | ⏳ 待完成 |
| TBD | M2: Phase 1-3 完成 | ⏳ 待完成 |
| TBD | M3: Phase 1-4 完成 | ⏳ 待完成 |
| TBD | M4: v2.2.0 發布 | ⏳ 待完成 |

---

**最後更新**: 2025-12-05
**狀態**: 📋 規劃中
**下一步**: 等待開發開始指示
