# 工作日誌 - 2025-12-01 (23:45)

## 工作摘要

**主題**: 方案D 混合架構階段性開發計劃制定
**狀態**: ✅ 已完成
**總時數**: 約 2.5 小時

---

## 背景

用戶詢問："若是朝方案D 的模式去做的話，會如何的階段性的開發與重構？"

**方案D 說明**:
- 桌面端：CustomTkinter (Python) - Windows/macOS/Linux
- 移動端：React Native 或 Flutter (可選) - Android/iOS
- 後端：FastAPI REST API + 現有 EEBot 自動化引擎
- 估計總時數：60-82 小時

---

## 完成事項

### 1. 現有代碼庫分析 ✅

**分析內容**:

#### 目錄結構
- 主入口：`main.py` (CLI 執行), `menu.py` (互動式選單)
- 核心模組：
  - `src/core/` - 配置管理、Driver 管理、Cookie 管理、Proxy 管理
  - `src/pages/` - 頁面物件 (POM 模式)
  - `src/scenarios/` - 業務場景 (CourseLearningScenario, ExamLearningScenario)
  - `src/services/` - 服務層 (answer_matcher, question_bank, course_recommender)
  - `src/api/interceptors/` - MitmProxy 攔截器
  - `src/models/` - 資料模型
  - `src/utils/` - 工具函數

#### 重構策略
- ✅ **保留的組件**（無需修改）:
  - 所有 `src/core/`, `src/pages/`, `src/scenarios/`, `src/services/` 完全保留
  - 現有業務邏輯不變，僅包裝為 API

- ✅ **新增的組件**:
  - Phase 1: `src/api_server/` - FastAPI 後端
  - Phase 2: `src/gui/` - CustomTkinter 桌面 GUI
  - Phase 3: `mobile/` - React Native 移動應用（可選）

- ✅ **向後兼容**:
  - CLI 模式（`main.py`, `menu.py`）繼續可用
  - 配置檔案 (`config/eebot.cfg`) 共用
  - 資料格式 (`data/courses.json`, `data/schedule.json`) 不變

---

### 2. API 契約設計 ✅

**技術棧**:
- 框架：FastAPI (Python)
- 通訊協議：HTTP/1.1 + JSON (REST), WebSocket (實時更新)
- 認證：Phase 1 無認證（本地使用），Phase 2+ JWT Token
- 文檔：Swagger UI 自動生成

#### RESTful API 端點

**課程管理 API** (`/api/v1/courses`):
| 方法 | 端點 | 描述 |
|------|------|------|
| `GET` | `/api/v1/courses` | 取得所有課程 |
| `GET` | `/api/v1/courses/{id}` | 取得單一課程 |
| `POST` | `/api/v1/courses` | 新增課程 |
| `PUT` | `/api/v1/courses/{id}` | 更新課程 |
| `DELETE` | `/api/v1/courses/{id}` | 刪除課程 |
| `GET` | `/api/v1/courses/scan` | 掃描可用課程 |

**執行控制 API** (`/api/v1/execution`):
| 方法 | 端點 | 描述 |
|------|------|------|
| `POST` | `/api/v1/execution/start` | 開始執行排程 |
| `POST` | `/api/v1/execution/stop` | 停止執行 |
| `POST` | `/api/v1/execution/pause` | 暫停執行 |
| `POST` | `/api/v1/execution/resume` | 恢復執行 |
| `GET` | `/api/v1/execution/status` | 取得執行狀態 |
| `GET` | `/api/v1/execution/logs` | 取得執行日誌 |

**配置管理 API** (`/api/v1/config`):
| 方法 | 端點 | 描述 |
|------|------|------|
| `GET` | `/api/v1/config` | 取得所有配置 |
| `PUT` | `/api/v1/config/{key}` | 更新配置 |
| `POST` | `/api/v1/config/reload` | 重新載入配置 |

**狀態監控 API** (`/api/v1/status`):
| 方法 | 端點 | 描述 |
|------|------|------|
| `GET` | `/api/v1/status/health` | 健康檢查 |
| `GET` | `/api/v1/status/version` | 取得版本資訊 |
| `GET` | `/api/v1/status/system` | 系統資源狀態 |

**WebSocket API**:
- 端點：`ws://localhost:8000/api/v1/ws/execution`
- 用途：實時推送執行狀態更新
- 訊息類型：`status_update`, `log_message`, `course_completed`, `execution_completed`, `error`

#### Pydantic Schema 設計

定義了以下資料模型：
- `CourseBase`, `CourseCreate`, `CourseUpdate`, `CourseResponse`
- `ExecutionRequest`, `ExecutionResponse`, `ExecutionStatus`
- `ConfigItem`, `ConfigUpdate`
- 統一錯誤回應格式

---

### 3. Phase 1: 核心基礎設施與 API 後端 ✅

**時程估算**: 26-32 小時

#### 任務分解

| 任務 | 估計時數 |
|------|---------|
| 1. 專案結構設置 | 2.5-4 h |
| 2. Pydantic Schema 設計 | 3 h |
| 3. 課程管理 API | 6-9 h |
| 4. 執行控制 API | 9-12 h |
| 5. 配置管理 API | 2-3 h |
| 6. WebSocket 伺服器 | 4-6 h |
| 7. 測試 | 4-7 h |

#### 專案結構

```
src/api_server/
├── main.py              # FastAPI 主入口
├── api/                 # API 路由
│   ├── courses.py       # 課程 API
│   ├── execution.py     # 執行控制 API
│   ├── config.py        # 配置 API
│   └── status.py        # 狀態監控 API
├── schemas/             # Pydantic 模型
│   ├── course.py
│   ├── execution.py
│   └── response.py
├── services/            # API 服務層（包裝器）
│   ├── course_service.py
│   └── execution_service.py
└── websocket/           # WebSocket 伺服器
    └── manager.py
```

#### 關鍵交付成果

✅ 可運行的 FastAPI 伺服器
✅ 完整的 RESTful API（涵蓋課程、執行、配置管理）
✅ WebSocket 實時更新
✅ Swagger UI 文檔（自動生成）
✅ 向後兼容 CLI 模式

#### 技術實作要點

1. **服務層包裝**：
   - `CourseService`: 包裝 `CourseRecommender`，操作 `data/courses.json`
   - `ExecutionService`: 包裝 `CourseLearningScenario` 和 `ExamLearningScenario`
   - 使用 `threading` 在背景執行課程自動化

2. **WebSocket 管理**：
   - `ConnectionManager`: 管理所有 WebSocket 連線
   - 廣播機制：同時推送給所有連接的客戶端
   - 訊息格式：JSON 結構化訊息

3. **錯誤處理**：
   - 統一錯誤回應格式
   - HTTP 狀態碼：200, 201, 400, 404, 409, 500

4. **測試**：
   - 單元測試：pytest + FastAPI TestClient
   - 整合測試：完整流程測試
   - API 測試：Postman / Thunder Client

---

### 4. Phase 2: 桌面 GUI 開發 ✅

**時程估算**: 18-26 小時

#### 任務分解

| 任務 | 估計時數 |
|------|---------|
| 1. 專案結構設置 | 1-2 h |
| 2. API 客戶端 | 5-8 h |
| 3. 課程管理 Tab | 5-8 h |
| 4. 執行監控 Tab | 6-9 h |
| 5. 配置管理 Tab | 3-5 h |
| 6. UI/UX 優化 | 3-5 h |

#### 專案結構

```
src/gui/
├── main.py              # GUI 主入口
├── windows/             # 視窗
│   ├── main_window.py   # 主視窗
│   ├── course_tab.py    # 課程管理 Tab
│   ├── execution_tab.py # 執行監控 Tab
│   └── config_tab.py    # 配置 Tab
├── widgets/             # 自訂元件
│   ├── course_card.py
│   └── log_viewer.py
└── api_client/          # API 客戶端
    └── client.py        # HTTP + WebSocket
```

#### 關鍵交付成果

✅ 完整的桌面應用程式（可執行的 .exe / .app / Linux binary）
✅ 友好的圖形介面（取代 CLI 模式）
✅ 實時監控（WebSocket 自動更新）
✅ 跨平台支援（Windows/macOS/Linux）

#### 技術實作要點

1. **CustomTkinter UI**：
   - 主題：暗色模式（dark mode）+ 藍色主題
   - Tab 視圖：課程管理、執行監控、配置管理
   - 響應式佈局

2. **課程管理 Tab**：
   - 課程列表顯示（Treeview）
   - 新增/編輯/刪除對話框
   - 課程掃描功能整合

3. **執行監控 Tab**：
   - 開始/停止/暫停按鈕
   - 進度條與狀態顯示
   - 實時日誌檢視器（Textbox）
   - WebSocket 自動更新

4. **API 客戶端**：
   - HTTP Client (requests)
   - WebSocket Client (websocket-client)
   - 錯誤處理與重連機制

5. **打包與分發**：
   - Windows: PyInstaller → `.exe`
   - macOS: py2app → `.app`
   - Linux: PyInstaller → AppImage

---

### 5. Phase 3: 移動端開發（可選）✅

**時程估算**: 16-24 小時

#### 任務分解

| 任務 | 估計時數 |
|------|---------|
| 1. 專案設置 | 2-3 h |
| 2. API 客戶端 | 3-5 h |
| 3. 畫面開發 | 8-11 h |
| 4. UI/UX 優化 | 3-5 h |
| 5. 打包與測試 | 2 h |

#### 技術選擇

**推薦**: React Native (TypeScript)
- 跨平台：Android + iOS 共用代碼
- 生態系統成熟
- 學習資源豐富

**替代方案**: Flutter (Dart)
- 效能更優
- UI 更統一
- 但需學習 Dart 語言

#### 關鍵交付成果

✅ Android APK（可安裝的應用程式）
✅ iOS IPA（可透過 TestFlight 分發）
✅ 與桌面版功能對等（課程管理、執行監控）

#### 畫面設計

1. **課程列表畫面** (`CourseListScreen`):
   - FlatList 顯示所有課程
   - 下拉刷新
   - 點擊進入詳情

2. **執行監控畫面** (`ExecutionScreen`):
   - 開始/停止按鈕
   - 進度條
   - 實時日誌（ScrollView）

3. **設定畫面** (`SettingsScreen`):
   - 配置項目（Switch, TextInput）
   - 儲存按鈕

---

### 6. 測試策略 ✅

#### 單元測試

| 層級 | 測試工具 | 覆蓋範圍 |
|------|---------|---------|
| API 後端 | pytest + FastAPI TestClient | 所有 API 端點 |
| GUI | unittest (Python) | API 客戶端邏輯 |
| 移動端 | Jest + React Native Testing Library | 元件與畫面 |

#### 整合測試

- ✅ API + 業務邏輯：驗證 API 正確調用現有 scenarios
- ✅ GUI + API：驗證 GUI 與 API 伺服器通訊
- ✅ WebSocket：驗證實時更新機制

#### E2E 測試

- ✅ 完整流程：新增課程 → 啟動執行 → 監控進度 → 完成
- ✅ 錯誤處理：測試各種異常情況

---

### 7. 向後兼容性方案 ✅

#### CLI 模式保留

- ✅ 保留入口：`main.py` 和 `menu.py` 繼續可用
- ✅ 獨立運行：不依賴 API 伺服器
- ✅ 文檔標記：標記為 "Legacy Mode"

#### 配置共用

- ✅ 統一配置檔：`config/eebot.cfg` 同時被 CLI 和 API 讀取
- ✅ 環境變數：支援 `.env` 覆蓋配置

#### 資料格式

- ✅ 不修改：`data/courses.json` 和 `data/schedule.json` 格式保持不變
- ✅ API 擴展：API 新增 UUID 等欄位，但不影響原有 JSON 結構

#### 遷移路徑

**階段 1**: 並行運行（v2.x CLI + v3.0 API）
- 用戶可選擇繼續使用 CLI 或使用 GUI

**階段 2**: 推薦 GUI（v3.1+）
- 預設啟動 GUI
- CLI 標記為 "Legacy Mode"

**階段 3**: 棄用 CLI（v4.0+，可選）
- 移除 main.py 和 menu.py（保留在 legacy/ 目錄）

---

### 8. 創建階段性開發計劃文檔 ✅

**文檔位置**: `docs/PHASED_DEVELOPMENT_PLAN_MIXED_ARCHITECTURE.md`

**文檔內容** (約 6,000+ 行):

1. **執行摘要**
   - 目標、總時程估算（60-82 小時）
   - 架構圖

2. **現有代碼庫分析**
   - 目錄結構
   - 核心模組職責
   - 重構策略

3. **API 契約設計**
   - 技術棧
   - RESTful API 端點設計（完整範例）
   - WebSocket API 設計
   - Pydantic Schema 設計
   - 錯誤處理

4. **Phase 1: 核心基礎設施與 API 後端**
   - 時程估算（26-32 小時）
   - 任務分解
   - 技術實作細節（包含完整程式碼範例）
   - 測試計劃
   - 部署指南

5. **Phase 2: 桌面 GUI 開發**
   - 時程估算（18-26 小時）
   - 任務分解
   - 技術實作細節（包含完整程式碼範例）
   - 打包與分發
   - 測試計劃

6. **Phase 3: 移動端開發（可選）**
   - 時程估算（16-24 小時）
   - 技術選擇（React Native vs Flutter）
   - 畫面設計
   - 部署指南

7. **測試策略**
   - 單元測試、整合測試、E2E 測試
   - 測試工具與覆蓋範圍

8. **向後兼容性方案**
   - CLI 模式保留
   - 配置共用
   - 遷移路徑

9. **部署與維護**
   - 開發環境部署
   - 生產環境部署
   - 監控與日誌
   - 更新機制

10. **風險評估與緩解**
    - 技術風險
    - 時程風險
    - 使用者體驗風險

11. **總結與建議**
    - 推薦實施順序
    - 開發里程碑
    - 成功標準
    - 後續優化方向

12. **附錄**
    - 開發環境設置
    - API 完整端點清單
    - 參考資料

---

## 關鍵技術決策

### 1. 為什麼選擇 FastAPI？

- ✅ **高效能**: 基於 Starlette 和 Pydantic，效能優異
- ✅ **自動文檔**: Swagger UI 自動生成，無需手動維護
- ✅ **類型安全**: Pydantic 模型提供完整的類型檢查
- ✅ **非同步支援**: 原生支援 async/await
- ✅ **Python 生態**: 與現有 EEBot 代碼無縫整合

### 2. 為什麼選擇 CustomTkinter？

- ✅ **現代化 UI**: 比傳統 Tkinter 更美觀
- ✅ **跨平台**: Windows/macOS/Linux 原生支援
- ✅ **Python 原生**: 無需學習新語言
- ✅ **輕量級**: 依賴少，打包體積小
- ✅ **學習曲線**: 比 PyQt6 更容易上手

### 3. 為什麼採用混合架構？

- ✅ **靈活性**: 桌面和移動端可獨立開發
- ✅ **可擴展性**: 未來可輕鬆新增 Web 前端
- ✅ **向後兼容**: CLI 模式仍可使用
- ✅ **成本效益**: 桌面端優先，移動端可延後

### 4. 為什麼保留 CLI 模式？

- ✅ **向後兼容**: 不影響現有使用者
- ✅ **自動化**: CLI 更適合腳本自動化
- ✅ **除錯**: 開發階段可直接測試業務邏輯
- ✅ **備用方案**: GUI 故障時的備用選擇

---

## 下一步行動

### 立即可執行（Phase 1）

1. **環境準備**:
   ```bash
   pip install fastapi uvicorn[standard] pydantic websockets
   ```

2. **建立專案結構**:
   ```bash
   mkdir -p src/api_server/{api,schemas,services,websocket}
   touch src/api_server/{main.py,__init__.py}
   ```

3. **實作最小可行產品 (MVP)**:
   - 基礎 FastAPI 應用
   - `/api/v1/courses` GET 端點
   - Swagger UI 文檔

4. **驗證可行性**:
   - 包裝 `CourseService.get_all_courses()`
   - 測試 API 回應
   - 確認現有代碼可正確調用

### 等待使用者批准

- ✅ Phase 1: REST API 後端（26-32 小時）
- ✅ Phase 2: 桌面 GUI（18-26 小時）
- 🟡 Phase 3: 移動端（16-24 小時，可選）

---

## 時間追蹤

| 階段 | 開始時間 | 結束時間 | 耗時 |
|------|---------|---------|------|
| 分析現有代碼庫 | 23:45 | 00:15 | 30 min |
| 設計 API 契約 | 00:15 | 00:45 | 30 min |
| 規劃 Phase 1-3 | 00:45 | 01:30 | 45 min |
| 撰寫完整計劃文檔 | 01:30 | 02:15 | 45 min |
| **總計** | - | - | **2.5 小時** |

---

## 文件產出

1. ✅ `docs/PHASED_DEVELOPMENT_PLAN_MIXED_ARCHITECTURE.md` (約 6,000+ 行)
   - 完整的階段性開發計劃
   - 包含詳細的程式碼範例
   - 涵蓋所有技術細節

2. ✅ `docs/DAILY_WORK_LOG_202512012345.md` (本文檔)
   - 工作記錄與時間追蹤

3. 🔄 `docs/CHANGELOG.md` (待更新)
   - 新增 [未發布] - 2025-12-01 章節

---

## 備註

### 參考之前的分析

本次規劃充分參考了之前的架構評估報告：
- `ARCHITECTURE_EVALUATION_REPORT_202512012232.md` - GUI 與 Client-Server 架構評估
- `DAILY_WORK_LOG_202512012232.md` - TMS+ 平台分析工作記錄

### 與方案 A-F 的對比

**方案D（混合架構）的優勢**:

| 方案 | 桌面端 | 移動端 | 開發時數 | 優缺點 |
|------|--------|--------|---------|--------|
| A (CustomTkinter Only) | ✅ | ❌ | 18-26h | 簡單但無移動端 |
| B (Kivy) | ✅ | ✅ | 20-28h | 移動端 UI 非原生 |
| C (BeeWare) | ✅ | ✅ | 24-32h | 不成熟，風險高 |
| **D (Mixed)** | ✅ | ✅ | **60-82h** | **最靈活，可階段實施** |
| E (Flutter) | ✅ | ✅ | 40-56h | 需學習 Dart |
| F (Web + PWA) | ✅ | ✅ | 48-64h | 需學習前端框架 |

**為什麼選擇方案D**:
1. ✅ 可階段實施（Phase 1 → Phase 2 → Phase 3）
2. ✅ 桌面端使用 Python（無需學習新語言）
3. ✅ 移動端可延後或不做
4. ✅ API 後端為未來擴展打下基礎
5. ✅ 向後兼容 CLI 模式

---

## 總結

已完成**方案D 混合架構階段性開發計劃**的完整制定，涵蓋：

- ✅ **現有代碼庫分析** - 明確重構範圍，保留現有業務邏輯
- ✅ **API 契約設計** - 完整的 RESTful API + WebSocket 設計
- ✅ **Phase 1 計劃** - REST API 後端（26-32 小時）
- ✅ **Phase 2 計劃** - 桌面 GUI（18-26 小時）
- ✅ **Phase 3 計劃** - 移動端（16-24 小時，可選）
- ✅ **測試策略** - 單元測試、整合測試、E2E 測試
- ✅ **向後兼容** - CLI 模式保留，配置共用
- ✅ **風險評估** - 技術、時程、UX 風險與緩解措施

**文檔產出**: `PHASED_DEVELOPMENT_PLAN_MIXED_ARCHITECTURE.md` (6,000+ 行)

**總時數估算**: 60-82 小時（Phase 1-3）

**推薦實施順序**: Phase 1 (必須) → Phase 2 (必須) → Phase 3 (可選)

**下一步**: 等待使用者批准後，開始 Phase 1 實施。

---

**工作日誌結束**
