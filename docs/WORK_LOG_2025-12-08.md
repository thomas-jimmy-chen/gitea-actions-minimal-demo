# 工作日誌 - 2025-12-08

## 📋 今日完成項目

### ✅ 混合掃描功能 (Hybrid Scan) - 主課程匹配部分

**功能說明：**
- 新增 `menu.py` 中的 'h' 選項
- 實現 API + Web 混合掃描
- 完成主課程（program）級別的匹配

**實現步驟：**

#### 1. 功能設計與 Code Review
- 設計 4 階段流程：初始化登入 → API 掃描 → Web 掃描 → 匹配演算法
- 獲得用戶批准後開始實作

#### 2. 階段 1: 初始化與登入
**遇到的問題與修正：**
- ❌ 錯誤導入路徑：`scripts.extractor` → ✅ `src.utils`
- ❌ ConfigLoader 錯誤：`ConfigLoader()` → ✅ `ConfigLoader('config/eebot.cfg')`
- ❌ DriverManager 錯誤：`get_driver()` → ✅ `create_driver(use_proxy=False)`
- ❌ LoginPage 錯誤：`LoginPage(driver, config)` → ✅ `LoginPage(driver, cookie_manager)`
- ❌ 登入方法錯誤：`goto() + login()` → ✅ `auto_login(username, password, url)`

#### 3. 階段 2: API 掃描
**遇到的問題與修正：**
- ❌ Session Cookie 提取：找不到 V2-* Cookie → ✅ 改用所有 Cookie 作為備用
- ❌ API URL 錯誤：未使用 urlparse → ✅ 正確提取基礎 URL
- ❌ Headers 不完整 → ✅ 新增完整的 HTTP Headers

**成功結果：**
- ✅ 成功調用 `/api/my-courses` API
- ✅ 獲取 18 門課程資料

#### 4. 階段 3: Web 掃描
**遇到的問題與修正：**
- ❌ CourseListPage 初始化錯誤：`CourseListPage(driver, config)` → ✅ `CourseListPage(driver)`
- ❌ get_program_courses_and_exams() 調用錯誤：傳入 program 字典 → ✅ 傳入 program_name 字串
- ❌ 資料結構假設錯誤：假設返回列表 → ✅ 返回 `{'courses': [...], 'exams': [...]}`

**成功結果：**
- ✅ 成功掃描 8 個修習中的主題
- ✅ 獲取每個主題下的課程與考試項目

#### 5. 階段 4: 匹配演算法 - API 結構分析
**關鍵發現：**
- 分析 Burp Suite 封包檔案：`api_my-courses_condition.txt`
- ❌ API **沒有** program_name 欄位
- ❌ API **沒有**階層結構
- ✅ API 的 `name`/`display_name` 就是完整的課程名稱
- ✅ Web 的 `program_name` 也是完整的課程名稱
- ✅ 可以直接匹配：`API.name ←→ Web.program_name`

**匹配演算法修正：**
```python
# 修正前（錯誤）
web_full_name = f"{program_name} {item_name}"  # 錯誤組合

# 修正後（正確）
api_name = api_course.get('name') or api_course.get('display_name')
web_program_name = web_course['program_name']
similarity = SequenceMatcher(None, api_name, web_program_name).ratio()
```

## 📁 今日創建的文檔

1. **API_STRUCTURE_ANALYSIS.md** - API 結構分析報告
2. **analyze_api_response.py** - API 回應分析腳本
3. **WORK_LOG_2025-12-08.md** - 本工作日誌

## 🔧 修改的文件

1. **menu.py**
   - 新增 display_menu() 的 'h' 選項 (line 109)
   - 新增 hybrid_scan() 函數 (line 570-959, 約 390 行)
   - 新增 run() 函數的 'h' 選項處理 (line 950-952)

## 📊 測試結果

- ✅ 階段 1: 初始化與登入 - 成功
- ✅ 階段 2: API 掃描 - 成功獲取 18 門課程
- ✅ 階段 3: Web 掃描 - 成功掃描 8 個主題
- ⏳ 階段 4: 匹配演算法 - 已完成主課程匹配邏輯，待完整測試

## 🔄 待完成工作

### 明日繼續：主課程下的子課程資料匹配

**需求：**
1. 分析子課程 API 端點（需要用戶提供一個範例）
2. 實現自動遍歷所有主課程，調用子課程 API
3. 匹配 API 子課程 ←→ Web 子課程（courses/exams）
4. 完整測試並生成 `hybrid_scan_result.json`

**信心值：95%**
- 給定一個子課程 API 範例即可自動實現

## 💡 技術重點

1. **模組導入路徑規則：**
   - `src.utils.*` - 工具類
   - `src.core.*` - 核心類
   - `src.pages.*` - 頁面類

2. **API 請求注意事項：**
   - 使用 `urlparse` 提取基礎 URL
   - Session Cookie: V2-* 格式（若無則使用全部）
   - 完整的 HTTP Headers
   - `verify=False` 跳過 SSL 驗證

3. **相似度匹配：**
   - 使用 `SequenceMatcher`
   - 閾值：0.7 (70%)
   - 信心等級：高 (≥0.9)、中 (≥0.8)、低 (≥0.7)

## 📝 經驗教訓

1. **參考現有代碼：** 'i' 函數是最佳參考範本
2. **先調試再實作：** 先打印資料結構，再寫匹配邏輯
3. **容錯處理：** API 結構可能與預期不同，需要備用方案
4. **Windows 兼容性：** 注意路徑和編碼問題
