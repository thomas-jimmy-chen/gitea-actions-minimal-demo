# 學習履歷統計 API 測試指南

## 📌 功能簡介

這是一個整合在 `menu.py` 中的研究工具,用於測試並驗證如何從 API 獲取首頁「學習履歷」統計資料:
- 學習進度 (%)
- 完成課程數
- 課程總數

---

## 🚀 使用方式

### 1. 啟動選單系統

```bash
python menu.py
```

### 2. 選擇測試功能

在主選單中輸入 `t` (test statistics):

```
操作說明：
  • 輸入 t - 測試學習履歷統計 API (研究用) 🔬 NEW
```

### 3. 等待自動執行

程式會自動執行以下步驟:

**階段 1/5: 初始化與登入**
- ✅ 載入配置
- ✅ 啟動瀏覽器
- ✅ 自動登入系統 (支援 3 次重試)

**階段 2/5: 提取 Session Cookie**
- ✅ 從瀏覽器中提取 `aenrich_session` cookie

**階段 3/5: 方案 1 - 從 /api/my-courses 計算統計**
- ✅ 調用 `/api/my-courses` API
- ✅ 計算統計資料 (完成課程數、總數、進度)
- ✅ 顯示課程明細

**階段 4/5: 方案 2 - 尋找專門的統計 API**
- ✅ 測試 5 個可能的統計 API 端點
- ✅ 報告哪些端點有效

**階段 5/5: 生成測試報告**
- ✅ 總結測試結果
- ✅ 儲存詳細報告至 `learning_stats_api_test_result.json`

---

## 📊 預期輸出

### 終端輸出範例:

```
======================================================================
  學習履歷統計 API 測試工具
======================================================================

此功能將：
  1. 初始化瀏覽器並登入系統
  2. 提取 session cookie
  3. 測試方案 1: 從 /api/my-courses 計算統計
  4. 測試方案 2: 尋找專門的統計 API
  5. 輸出完整測試報告

----------------------------------------------------------------------
[階段 1/5] 初始化與登入
----------------------------------------------------------------------

[初始化 1/3] 載入配置...
  ✓ 配置已載入
[初始化 2/3] 啟動瀏覽器...
[初始化 3/3] 初始化頁面物件...
  ✓ 頁面物件已初始化

正在登入... (第 1/3 次)
✓ 登入成功！

----------------------------------------------------------------------
[階段 2/5] 提取 Session Cookie
----------------------------------------------------------------------
✓ 成功提取 session cookie
  Cookie 長度: 128 字元

----------------------------------------------------------------------
[階段 3/5] 方案 1: 從 /api/my-courses 計算統計
----------------------------------------------------------------------

調用 API: GET /api/my-courses

✓ API 調用成功！

📊 學習履歷統計:
  學習進度: 100.0%
  完成課程: 8
  進行中課程: 0
  課程總數: 8

📚 課程明細:
  ✅ 已完成 - 資通安全教育訓練
  ✅ 已完成 - 金融友善服務
  ✅ 已完成 - 個人資料保護法
  ...

----------------------------------------------------------------------
[階段 4/5] 方案 2: 尋找專門的統計 API
----------------------------------------------------------------------

測試 5 個可能的 API 端點...

  測試: /api/user/statistics ❌ 404
  測試: /api/dashboard/summary ❌ 404
  測試: /api/learning/progress ❌ 404
  測試: /api/my-learning-stats ❌ 404
  測試: /api/user/progress ❌ 404

----------------------------------------------------------------------
[階段 5/5] 生成測試報告
----------------------------------------------------------------------

======================================================================
  測試結果總結
======================================================================

【方案 1】從 /api/my-courses 計算:
  ✅ 成功
  統計: 8/8 課程完成 (100.0%)

【方案 2】尋找專門統計 API:
  ❌ 未找到專門的統計 API

✓ 詳細報告已儲存至: learning_stats_api_test_result.json

✓ 瀏覽器已關閉

按 Enter 返回主選單...
```

---

## 📄 輸出檔案

測試完成後會生成 `learning_stats_api_test_result.json`:

```json
{
  "test_time": "2025-12-14 15:30:00",
  "calculated_from_my_courses": {
    "success": true,
    "total": 8,
    "completed": 8,
    "in_progress": 0,
    "progress": 100.0,
    "courses_count": 8
  },
  "api_test_results": [
    {
      "endpoint": "/api/user/statistics",
      "status": 404,
      "success": false
    },
    ...
  ],
  "successful_endpoints": [],
  "recommendation": "建議使用方案 1 (從 my-courses 計算)"
}
```

---

## 🎯 測試結果解讀

### ✅ 方案 1 成功
如果方案 1 成功,表示可以使用 `/api/my-courses` API 計算學習履歷統計:
- **優點**: 簡單、可靠、已驗證
- **實作**: 直接整合到主程式即可

### ✅ 方案 2 找到有效 API
如果方案 2 找到有效的統計 API:
- **優點**: 可能更精確、更快速
- **實作**: 優先使用該 API

### ❌ 兩個方案都失敗
- **可能原因**: 登入失敗、Session 過期、網路問題
- **解決方式**: 重新執行測試

---

## 🔧 技術細節

### 核心邏輯

**方案 1: 從 my-courses 計算**
```python
# 1. 調用 API
response = requests.get('https://elearn.post.gov.tw/api/my-courses',
                        cookies={'aenrich_session': session_cookie})

# 2. 計算統計
courses = response.json()['courses']
total = len(courses)
completed = len([c for c in courses if c['is_graduated'] == True])
progress = (completed / total * 100) if total > 0 else 0
```

**方案 2: 測試專門 API**
```python
# 測試可能的端點
endpoints = [
    "/api/user/statistics",
    "/api/dashboard/summary",
    "/api/learning/progress",
    ...
]

for endpoint in endpoints:
    response = requests.get(base_url + endpoint, cookies=...)
    if response.status_code == 200:
        # 找到有效 API
```

---

## 📝 與獨立腳本的差異

| 項目 | 獨立腳本 | menu.py 整合 |
|------|----------|-------------|
| 登入方式 | 需手動提供 cookie | ✅ 自動登入 |
| 使用便利性 | 需額外執行 | ✅ 選單中直接選擇 |
| 配置讀取 | 需手動處理 | ✅ 自動載入 |
| 重試機制 | 無 | ✅ 支援 3 次重試 |
| 報告輸出 | JSON 檔案 | ✅ 終端 + JSON |

---

## ⚠️ 注意事項

1. **登入必要性**: 此功能需要登入,因此必須配置好 `.env` 或 `config/eebot.cfg` 中的帳號密碼
2. **網路連線**: 測試過程需要網路連線
3. **執行時間**: 預計 30-60 秒 (含登入)
4. **瀏覽器視窗**: 會短暫開啟 Chrome 視窗進行登入

---

## 🎓 學習價值

這個功能展示了如何:
1. ✅ 複用現有登入機制 (DRY 原則)
2. ✅ 提取並使用 session cookie
3. ✅ 測試多個可能的 API 端點
4. ✅ 生成結構化的測試報告
5. ✅ 整合研究工具到主程式

---

## 🔗 相關文檔

- [API 驗證實驗指南](../scripts/api_verification/README.md)
- [CLAUDE_CODE_HANDOVER.md](./CLAUDE_CODE_HANDOVER.md)
- [CHANGELOG.md](../CHANGELOG.md)

---

**建立日期**: 2025-12-14
**維護者**: wizard03 with Claude Code (Sonnet 4.5)
**專案**: EEBot (Gleipnir)
