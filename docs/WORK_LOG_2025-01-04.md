# 工作日誌 - 2025-01-04

**Session 時間**: 下午
**版本**: v2.5.0 → v2.5.1
**主題**: 空白頁檢測與自動重刷機制實作

---

## 本日完成事項

### 1. 問題分析與討論

**問題**: 執行過程中偶爾遇到空白頁面，需手動重刷才能繼續

**分析結論**:
- 主要發生在考試頁面
- 原因: AngularJS 初始化偶發失敗 / 首次載入 race condition
- 解決方案: 手動重刷即可恢復，無需複雜的 iframe 處理

**設計決策**:
- 採用漸進式處理：HTML 檢測 → 重刷 → (必要時) iframe 方案
- 重刷 3 次，使用 Exponential Backoff (2/4/6 秒)
- 區分伺服器錯誤 (50X 可重刷) 與客戶端錯誤 (40X 不重刷)

---

### 2. 實作空白頁檢測機制

**修改檔案**: `src/pages/base_page.py`

**新增類別**:
```python
class PageLoadError(Exception):
    """頁面載入錯誤的自訂異常"""
    def __init__(self, message, error_type=None, status_code=None):
        self.error_type = error_type  # 'server_error', 'blank_page', 'client_error'
        self.status_code = status_code
```

**新增方法**:

| 方法 | 功能 |
|------|------|
| `detect_server_error()` | 檢測伺服器錯誤 (50X/40X) |
| `check_page_blank()` | 檢測空白頁 (組合策略 D) |
| `ensure_page_loaded()` | 確保頁面載入，空白自動重刷 |
| `navigate_to()` | 導航並確保載入完成 |

**組合策略 D (空白頁檢測)**:
- A: body 可見性 (`display !== 'none'`)
- B: 內容長度 (> 100 字符)
- C: 關鍵元素存在 (PAGE_LOAD_INDICATOR)

---

### 3. 各頁面添加 PAGE_LOAD_INDICATOR

| 頁面 | PAGE_LOAD_INDICATOR |
|------|---------------------|
| `ExamDetailPage` | `.exam-subjects`, `.exam-activity-box`, `[ng-bind='exam.title']` |
| `ExamAnswerPage` | `.subject`, `.subject-description`, `.option` |
| `CourseListPage` | `[ng-bind='course.display_name']`, `.course-list`, `.my-courses` |
| `CourseDetailPage` | `.clickable-area`, `.activity-content-box`, `[ng-bind='activity.title']` |
| `LoginPage` | `#user_name`, `.login-content`, `#submit` |

---

### 4. 錯誤處理流程

```
頁面載入完成
    ↓
檢測伺服器錯誤 (50X/40X)
    ├─ 40X → 直接報錯 (不重刷)
    ├─ 50X → 延長等待 + 重刷 (最多 3 次)
    └─ 無錯誤 → 繼續
           ↓
    檢測空白頁 (組合策略 D)
        ├─ 空白 → 重刷 (最多 3 次，backoff 2/4/6 秒)
        └─ 正常 → 繼續執行
               ↓
          頁面載入成功 ✓
```

---

### 5. 伺服器錯誤檢測模式

**50X 錯誤 (可重刷)**:
- 500: Internal Server Error, 內部伺服器錯誤
- 502: Bad Gateway, 錯誤的閘道
- 503: Service Unavailable, 服務暫時無法使用
- 504: Gateway Timeout, 閘道逾時

**40X 錯誤 (不重刷)**:
- 400: Bad Request
- 401: Unauthorized, 未授權
- 403: Forbidden, 禁止存取
- 404: Not Found, 找不到頁面

**伺服器特徵檢測**:
- nginx, Apache 錯誤頁
- "請稍後再試", "系統維護中"

---

## 修改檔案清單

| 檔案 | 變更類型 | 說明 |
|------|----------|------|
| `src/pages/base_page.py` | 修改 | 新增空白頁檢測、伺服器錯誤檢測、自動重刷 |
| `src/pages/exam_detail_page.py` | 修改 | 新增 PAGE_LOAD_INDICATOR |
| `src/pages/exam_answer_page.py` | 修改 | 新增 PAGE_LOAD_INDICATOR |
| `src/pages/course_list_page.py` | 修改 | 新增 PAGE_LOAD_INDICATOR |
| `src/pages/course_detail_page.py` | 修改 | 新增 PAGE_LOAD_INDICATOR |
| `src/pages/login_page.py` | 修改 | 新增 PAGE_LOAD_INDICATOR |
| `src/pages/__init__.py` | 修改 | 導出 PageLoadError 及所有頁面類別 |

---

## 使用方式

```python
from src.pages import ExamDetailPage, PageLoadError

# 方式 1: 自動導航 + 檢測
page = ExamDetailPage(driver)
try:
    page.navigate_to("https://example.com/exam/123")
    # 頁面正常載入，繼續操作
except PageLoadError as e:
    print(f"頁面載入失敗: {e}")
    print(f"錯誤類型: {e.error_type}")

# 方式 2: 在現有流程中手動觸發檢測
page.driver.get(url)
page.ensure_page_loaded()  # 空白就自動重刷
```

---

## 討論記錄

### 問題: 空白頁主要發生在哪些頁面？

**答**: 主要發生在考試頁面，手動按重刷就會恢復。

### 設計決策

1. **不需要新的 Burp Suite 分析** - 現有 `EXAM_PAGE_RENDERING_ANALYSIS.md` 已足夠
2. **採用漸進式方案** - 簡單檢測 + 重刷，不過度複雜化
3. **每個頁面都做檢測** - 防禦性設計，避免任何頁面載入空白
4. **重刷 3 次** - 預留合理延遲，應對伺服器暫時性問題

---

## 下次接續點

1. **實際環境測試** - 驗證空白頁檢測機制效果
2. **整合到主流程** - 在關鍵導航點調用 `ensure_page_loaded()`
3. **tour.post CAPTCHA OCR** - 建立整合模組

---

## 相關文檔

- [考試頁面渲染分析](./EXAM_PAGE_RENDERING_ANALYSIS.md)
- [Burp Suite 分析索引](./BURP_SUITE_ANALYSIS_INDEX.md)
- [交接文檔](./CLAUDE_CODE_HANDOVER-14.md)

---

**文檔建立者**: Claude Code (Opus 4.5)
**Session 結束時間**: 2025-01-04
