# 工作日誌 2025-12-28

## 主題: CAPTCHA OCR 技術研究與實作

---

## 1. 研究成果總覽

### 1.1 準確率提升

```
原始方法 (Auto-WFH):  34.8%
單一策略 (v3_islands): 75.7%  (+40.9%)
多策略優化:           97.6%  (+21.9%)
────────────────────────────────────
總提升:               +62.8%
```

### 1.2 執行時間 (50 樣本平均)

| 方法 | 每張耗時 | 說明 |
|------|---------|------|
| v3_islands | 129ms | 單一策略基準 |
| Optimized | 608ms | 多策略 (4.7x 較慢但可接受) |

---

## 2. 技術實作

### 2.1 測試的 9 種方法 (420 樣本)

| 方法 | 成功率 | 高精度(4位) | 說明 |
|------|--------|------------|------|
| **Optimized** | **97.6%** | 68.1% | 多策略 (推薦) |
| v3_islands | 75.7% | 52.1% | CC 面積過濾 |
| v8_twostage | 75.5% | 50.5% | 侵蝕+CC+膨脹 |
| v7_multidim | 71.2% | 44.3% | 多維度過濾 |
| v1_original | 34.8% | 19.3% | Auto-WFH 原始 |

### 2.2 多策略優化方法

```python
strategies = [
    (preprocess_v3, min_size=40, psm=7),    # 標準
    (preprocess_v3, min_size=35, psm=7),    # 較小閾值
    (preprocess_v3, min_size=30, psm=7),    # 更小閾值
    (preprocess_v3, min_size=40, psm=8),    # 單字模式
    (preprocess_v3, min_size=40, psm=13),   # 原始行模式
    (preprocess_clahe, min_size=40, psm=7), # CLAHE 增強
    (preprocess_clahe, min_size=35, psm=7),
    (preprocess_adaptive, min_size=30, psm=7), # 自適應閾值
    (preprocess_sharpen, min_size=40, psm=7),  # 銳化
]
```

### 2.3 失敗案例分析

| 失敗類型 | 數量 | 比例 |
|---------|------|------|
| 識別 2 位 | 47 | 46% |
| 完全空白 | 30 | 29% |
| 識別 1 位 | 25 | 25% |

**結論**: 失敗案例多為數字被過度過濾，而非對比度問題。

---

## 3. 工具程式

### 3.1 主要工具

| 檔案 | 用途 | 使用方式 |
|------|------|---------|
| `optimized_ocr.py` | **推薦** 97.6% 準確率 | `recognize_with_fallback(path)` |
| `captcha_profiles.py` | Profile 系統 | `recognize_with_profile(path, 'tronclass')` |
| `benchmark.py` | 效能測試 | `python benchmark.py` |
| `analyze_failures.py` | 失敗分析 | `python analyze_failures.py` |

### 3.2 快速使用

```python
# 推薦: 多策略版 (97.6%)
from research.captcha_ocr_analysis.optimized_ocr import recognize_with_fallback
success, result, confidence = recognize_with_fallback('captcha.png')

# 備選: Profile 版 (75.7%)
from research.captcha_ocr_analysis.captcha_profiles import recognize_with_profile
success, result, confidence = recognize_with_profile('captcha.png', 'tronclass')
```

---

## 4. 檔案結構

```
research/captcha_ocr_analysis/
├── optimized_ocr.py        # 多策略優化版 (97.6%) ★
├── captcha_profiles.py     # Profile 系統 (75.7%)
├── improved_ocr.py         # 9種預處理方法
├── analyze_failures.py     # 失敗案例分析
├── benchmark.py            # 效能基準測試
├── fast_tune.py            # 快速參數調優
├── auto_collect_captcha.py # 樣本收集腳本
├── samples/                # 420張 CAPTCHA 樣本
└── failed_samples/         # 失敗案例
```

---

## 5. 嘗試但放棄的方案

### 5.1 ddddocr
- **問題**: `PIL.Image.ANTIALIAS` 已在 Pillow 10+ 移除
- **結果**: 0% 成功率
- **結論**: 與當前環境不兼容，放棄

### 5.2 Grid Search 參數調優
- **問題**: 420 樣本太慢
- **解決**: 建立 fast_tune.py (100 樣本 + 驗證)
- **結論**: min_size=40 已是最佳值

---

## 6. 下階段任務 (P0 優先)

詳見 `docs/TODO.md` 及 `docs/CLAUDE_CODE_HANDOVER-8.md`

---

## 7. 參考資料

- [Auto-WFH](https://github.com/dec880126/Auto-WFH)
- [PyImageSearch CC Tutorial](https://pyimagesearch.com/2021/02/22/opencv-connected-component-labeling-and-analysis/)
- [Simple-Captcha-Breaker](https://cagriuysal.github.io/Simple-Captcha-Breaker/)
- [kingsman142/captcha-solver](https://github.com/kingsman142/captcha-solver)
